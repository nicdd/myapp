<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-progress-button/paper-progress-button.html">
<link rel="import" href="../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../first-domain-styles.html">
<link rel="import" href="../table-styles.html">
<link rel="import" href="../clients/firstclient.html">
<link rel="import" href="../clients/basicclient.html">

<link rel="import" href="../utils/grt-grid-pagination.html">
<link rel="import" href="../utils/export-chooser.html">
<link rel="import" href="../utils/grt-dialog.html">
<link rel="import" href="../utils/apps-dialog.html">
<link rel="import" href="../utils/column-sorter.html">
<link rel="import" href="../utils/grt-sand-clock.html">
<link rel="import" href="../utils/grt-gartler.html">
<link rel="import" href="../utils/grt-gartler-history.html">

<dom-module id="my-foerdermitglieder">
    <template>
        <style include="first-domain-styles table-styles">
            :host {
                /* Stretch this element to fill viewport */
                height: calc(100vh - 88px);
                flex: 1;
                /* Make a flex column layout of children */
                display: flex;
                flex-direction: column;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                background-color: var(--my-yellow-background);
                padding: var(--content-padding);
            }

            .toolbar {
                /* height: 40px; */
                padding: 5px;
                /*line-height: 32px;*/
                background: #eee;
            }

            iron-collapse-button {
                cursor: cursor;
                padding-right: 12px;
            }

            iron-collapse-button div[slot="collapse-trigger"] {
                height: 48px;
                line-height: 48px;
            }

            iron-collapse-button div[slot="collapse-content"] {
                margin-right: -12px;
            }

            paper-button {
                padding: 0.2em 0.5em 0.2em 0.5em !important;
            }

            .button {
                padding: 0px 2px 0px 2px !important;
            }

            .rightalign {
                text-align: right !important;
            }

            .centered-cell {
                text-align: center !important;
                vertical-align: middle !important;
            }

        </style>

         <first-client id="firstclient"></first-client>
        <basic-client id="bclient"></basic-client>
        <grt-dialog id="deletedialog" dialog-type="confirmation" confirmation-name="Löschen" cancel-name="Abbrechen"
            on-grtconfirm="_removeItem"></grt-dialog>
        <grt-dialog id="grtinfodialog" dialog-type="info"></grt-dialog>
        <export-chooser id="exportdialog" dialog-type="info" confirmation-name="Schließen"
            on-export-data="exportPaechter"></export-chooser>
        <apps-dialog id="appsdialog" action-buttons="[[actionButtons]]" tasks="[[getSelected(mvdata.*)]]"></apps-dialog>
        <grt-sand-clock id="sandhour"></grt-sand-clock>
        <div>
            <div class="toolbar layout horizontal justified" flex>
                <template is="dom-if" if="[[columnNames.length]]">
                    <grt-grid-pagination id="pagesss" datalength="[[mvdata.length]]" page-size="{{pageSize}}"
                        pstart="{{_pageStart}}" on-pagechanged="changePage" style-domain="first-domain">
                    </grt-grid-pagination>
                </template>
                <div class="layout horizontal justified" flex="50">
                    <button id="appsbutton" on-click="_showApps" disabled="[[_noOneSelected(mvdata.*)]]"
                        class="action-button">
                        <iron-icon icon="apps" id="appsicon" slot="item-icon" on-click="_showApps"></iron-icon>
                    </button>
                    <paper-button disabled="[[isSaveAllDisabled(mvdata.*, openeddetails.*, _isAenderung)]]" bottom
                        raised on-click="postPaechter">Speichern</paper-button>
                    <paper-button disabled="[[isExportDisabled(mvdata.*, openeddetails.*)]]" bottom raised
                        on-click="_showExportDialog">Exportieren</paper-button>
                </div>
            </div>
            <div class="demo">
                <div class="table-responsive-vertical shadow-z-1">
                    <table id="table" class="table table-condensed table-hover">
                        <thead>
                            <th class="centered-cell">
                                <paper-checkbox on-change="_checkAll" checked="[[_areAllSelected(mvdata.*)]]">
                                </paper-checkbox>
                            </th>
                            <th>
                                <column-sorter colname="[[columnNames.0]]" path="GARTENNUMMER"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="[[columnNames.1]]" path="ANREDE"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="[[columnNames.2]]" path="NACHNAME"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="[[columnNames.3]]" path="VORNAME"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="[[columnNames.8]]" path="WOHNORT"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="[[columnNames.9]]" path="FLAECHE"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="Alter" path="GEBURTSDATUM"
                                    on-sorter-changed="_sortByGeburtsdatum">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="Geb." path="GEBURTSDATUM"
                                    on-sorter-changed="_sortByGeburtsdatum">
                                </column-sorter>
                            </th>
                            <th>
                                <column-sorter colname="Jubiläum" path="GEBURTSDATUM"
                                    on-sorter-changed="_sortByJubilaeum">
                                </column-sorter>
                            </th>


                            <th>
                                <column-sorter colname="[[columnNames.12]]" path="BEMERKUNGEN"
                                    on-sorter-changed="_sortChange">
                                </column-sorter>
                            </th>
                            <th class="button"></th>
                            <th class="button"></th>
                        </thead>
                        <tbody>
                            <template is="dom-repeat" items="[[mvpagedata]]">
                                <tr class$="[[item.paechter.status]]">
                                    <td class="centered-cell">
                                        <paper-checkbox class="[[getClassByBeitrag(item.BEITRAG)]]"
                                            id="[[getGridElementID(index, _pageStart, 'scb')]]" on-change="_checkOne"
                                            checked="[[_isItemSelected(_pageStart, index, mvdata.*)]]"></paper-checkbox>
                                    </td>
                                    <td class="rightalign">[[item.GARTENNUMMER]]</td>
                                    <td>[[item.ANREDE]]</td>
                                    <td>[[item.NACHNAME]]</td>
                                    <td>[[item.VORNAME]]</td>
                                    <td>[[item.WOHNORT]]</td>
                                    <td class="rightalign">[[item.FLAECHE]]</td>
                                    <td class="rightalign">[[getAlterBy(item.GEBURTSDATUM)]]</td>
                                    <td class="rightalign">[[item.GEBURTSDATUM]]</td>
                                    <td>[[getJubilaeumBy(item.GEBURTSDATUM)]]</td>
                                    <td>[[item.BEMERKUNGEN]]</td>
                                    <td class="button">
                                        <button id="bto[[item.GARTENNUMMER]]" on-click="_openDetails"
                                            class="first-domain-endpagebutton action-button">
                                            <iron-icon id="cro[[item.GARTENNUMMER]]"
                                                icon="[[getIcon(item._detailsOpened)]]" slot="item-icon"
                                                on-click="_openDetails"></iron-icon>
                                        </button>
                                    </td>
                                    <td class="button">
                                        <button id="btr[[item.GARTENNUMMER]]" on-click="_confirmRemove"
                                            class="first-domain-endpagebutton action-button"
                                            disabled="[[item._detailsOpened]]">
                                            <iron-icon id="rmi[[item.GARTENNUMMER]]-[[index]]" icon="delete"
                                                slot="item-icon" on-click="_confirmRemove"></iron-icon>
                                        </button>
                                    </td>
                                </tr>
                                <template is="dom-if" if="[[item._detailsOpened]]">
                                    <tr class="details">
                                        <td colspan="13" class="no-padding">
                                            <iron-collapse-button expand-icon="add-circle-outline"
                                                collapse-icon="remove-circle-outline"
                                                class="detailelement light-element flex" opened>
                                                <div slot="collapse-trigger" class="flex">
                                                    <span>Pachtvertragsdaten</span>
                                                </div>
                                                <div slot="collapse-content" class="corrected-margin">
                                                    <div class="mcard strong-text-color">
                                                        <div class="layout horizontal">
                                                            <table width="25%">
                                                                <thead>
                                                                    <th colspan="2">Garten</th>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td>[[columnNames.0]]</td>
                                                                        <td>[[item.GARTENNUMMER]]</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>[[columnNames.22]]</td>
                                                                        <td>[[item.WEG]]</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>[[columnNames.9]]</td>
                                                                        <td>[[item.FLAECHE]]</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <table width="25%">
                                                                <thead>
                                                                    <th colspan="2">Anschrift</th>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td>Name</td>
                                                                        <td>[[item.ANREDE]] [[item.VORNAME]]
                                                                            [[item.NACHNAME]]</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>[[columnNames.5]]</td>
                                                                        <td>[[item.STRASSE]]</td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>[[columnNames.8]]</td>
                                                                        <td>[[item.PLZ]] [[item.WOHNORT]]</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <table width="25%">
                                                                <thead>
                                                                    <th colspan="2">Kontakt</th>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td>[[columnNames.10]]</td>
                                                                        <td><a
                                                                                href="tel:[[item.TELEFON]]">[[item.TELEFON]]</a>
                                                                        </td>
                                                                    </tr>
                                                                    <tr>
                                                                        <td>[[columnNames.11]]</td>
                                                                        <td><a
                                                                                href="mailto:[[item.EMAIL]]">[[item.EMAIL]]</a>
                                                                        </td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                            <table width="25%">
                                                                <thead>
                                                                    <th colspan="2">Details</th>
                                                                </thead>
                                                                <tbody>
                                                                    <tr>
                                                                        <td>[[columnNames.4]]</td>
                                                                        <td>[[item.GEBURTSDATUM]]</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </iron-collapse-button>
                                        </td>
                                    </tr>
                                    <tr class="details">
                                        <td colspan="13" class="no-padding">
                                            <iron-collapse-button expand-icon="add-circle-outline"
                                                collapse-icon="remove-circle-outline"
                                                class="detailelement light-element flex" opened>
                                                <div slot="collapse-trigger" class="flex">
                                                    <div class="layout horizontal justified">
                                                        <span>Datenbearbeitung</span>
                                                    </div>
                                                </div>
                                                <div slot="collapse-content" class="corrected-margin">
                                                    <div class="mcard strong-text-color">
                                                        <grt-gartler id="grtl[[index]]" gartler="[[item]]"
                                                            on-savegartler="_postOneFM">
                                                            <h4 slot="title">Pächter</h4>>
                                                        </grt-gartler>

                                                    </div>
                                                </div>
                                            </iron-collapse-button>
                                        </td>
                                    </tr>
                                    <tr class="details">
                                        <td colspan="13" class="no-padding">
                                            <iron-collapse-button id="history_clps[[index]]" expand-icon="add-circle-outline"
                                                collapse-icon="remove-circle-outline"
                                                class="detailelement light-element flex">
                                                <div slot="collapse-trigger" class="flex">
                                                    <div class="layout horizontal justified">
                                                        <span>Änderungshistorie</span>
                                                    </div>
                                                </div>
                                                <div slot="collapse-content" class="corrected-margin">
                                                    <div class="mcard strong-text-color">
                                                        <grt-gartler-history id="history[[index]]" garten="[[item.GARTENNUMMER]]">
                                                            <h4 slot="title">Pächter</h4>
                                                        </grt-gartler-history>

                                                    </div>
                                                </div>
                                            </iron-collapse-button>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>





    <script>
        class MyFoerdermitglieder extends Polymer.Element {
            static get is() { return 'my-foerdermitglieder'; }

            static get properties() {
                return {
                    mbgclr:{
                        type: String,
                        value: "red"
                    },
                    logg:{
                        type: Boolean,
                    },
                    actionButtons: {
                        type: Array,
                        value: ['email', 'rechnung', 'meldung', 'brief']
                    },

                    pageSize: {
                        type: Number,
                        value: null,
                        notify: true,
                        observer: 'changePage'
                    },

                    _pageStart: {
                        type: Number,
                        value: 0
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    mvdata: {
                        type: Array,
                        value: [],
                        notify: true,
                        reflectToAttribute: true
                    },

                    mvpagedata: {
                        type: Array,
                        value: [],
                        notify: true,
                        reflectToAttribute: true
                    },

                    _pages: {
                        type: Object,
                        value: null
                    },

                    selected: {
                        type: Boolean,
                        value: false,
                        observer: '_activeChanged',
                    },

                    columnNames: {
                        type: Array,
                        value: []
                    },

                    openeddetails: {
                        type: Array,
                        value: []
                    },

                    _isAenderung: {
                        type: Boolean
                    }
                }
            }

            

            _confirmRemove(e) {
                e.preventDefault();
                this.$.deletedialog.showDialog(
                    {
                        "title": "Pächterdaten Löschen",
                        "message": "Bitte bestätigen Sie, dass Sie den Datensatz wirklich entfernen möchten.",
                        "origData": e.target.id.substring(3)
                    })
                e.stopPropagation();
            }

            _removeMetadata(paechter) {
                let vToSave = JSON.parse(JSON.stringify(paechter))
                const keysToReset = ["selected", "_detailsOpened"];
                Object.keys(vToSave).forEach((vkey) => {
                    if (keysToReset.some((elem) => elem === vkey)) {
                        delete vToSave[vkey];
                    }
                })
                return vToSave;
            }

            ready() {
                super.ready();
                
                if (this.$)
                this.$ = new Proxy(this.$, {
                    get: ($, id) => $[id] || this.shadowRoot.getElementById(id),
                    set: ($, id, element) => {
                        $[id] = element;
                        return true;
                    }
                });
            
                this.$.firstclient.getAsJSON('paechter').then((resp) => {
                    if (resp) {
                        this.splitToObjects(resp).finally(() => {
                            //wenn pageSize nur an einer stelle initialisiert wird (in then von splitToObjects)
                            // dann der gleiche wert 10 wird nicht noch mal zu der pagination Componente getriggert
                            // denn er sich noch nicht geändert hatte, die Komp beim ersten mal aber nicht da war
                            this.set('pageSize', parseInt(0));
                            this.changePage();
                        });
                    } else {
                        showToast(this, 'Bei der Initialisierung der Seite wurden keine Pächterdaten gefunden', TOAST_TYPE.ERROR);
                    }
                }).catch((err) => {
                    console.log("Fehler beim get fuer paechter  kam:" + JSON.stringify(err))
                    showToast(this, 'Die Paecheterdaten konnten nicht geladen werden', TOAST_TYPE.ERROR);
                })
            }

            _openDetails(e) {
                e.model.set("item._detailsOpened", !e.model.item._detailsOpened);
                if (e.model.item._detailsOpened) {
                    this.push('openeddetails', true);
                } else {
                    this.shift('openeddetails');
                }
                e.stopPropagation();
            }

            _sortChange(e) {
                let self = this;
                if (e.target && e.target.path && e.target.direction) {
                    let otherSorter = this.shadowRoot.querySelectorAll('column-sorter');
                    otherSorter.forEach((os) => {
                        if (os.direction && (os.colname !== e.target.colname)) {
                            os.direction = null;
                        }
                    })
                    let key = e.target.path;
                    let direction = e.target.direction;
                    let records = JSON.parse(JSON.stringify(self.mvdata));
                    if (key === 'GARTENNUMMER') {
                        // For Number-like Strings containing alphanummerical chars
                        records = records.sort(function (o1, o2) {
                            let result = self.naturalSorter((o1.GARTENNUMMER || "0"), (o2.GARTENNUMMER || "0"));
                            if (direction === 'asc') {
                                return (result < 0) ? -1 : 1;
                            } else {
                                return (result < 0) ? 1 : -1;
                            }
                            return 0;
                        });
                    } else if (!isNaN(this.mvdata[0][key])) {
                        // for numbers
                        records.sort(function (a, b) {
                            if (direction === 'asc') {
                                if (a[key] < b[key]) return -1;
                                if (a[key] > b[key]) return 1;
                            } else {
                                if (a[key] < b[key]) return 1;
                                if (a[key] > b[key]) return -1;
                            }
                            return 0;
                        });
                    } else {
                        // for strings
                        records.sort(function (a, b) {
                            if (direction === 'asc') {
                                if ((a[key] || "").toLowerCase() < (b[key] || "").toLowerCase()) return -1;
                                if ((a[key] || "").toLowerCase() > (b[key] || "").toLowerCase()) return 1;
                            } else {
                                if ((a[key] || "").toLowerCase() < (b[key] || "").toLowerCase()) return 1;
                                if ((a[key] || "").toLowerCase() > (b[key] || "").toLowerCase()) return -1;
                            }
                            return 0;
                        });

                    }
                    self.set('mvdata', records);
                    self.changePage();
                }
            }

            _sortByGeburtsdatum(e) {
                let self = this;
                if (e.target && e.target.path && e.target.path === 'GEBURTSDATUM' && e.target.direction) {
                    let otherSorter = this.shadowRoot.querySelectorAll('column-sorter');
                    otherSorter.forEach((os) => {
                        if (os.direction && (os.colname !== e.target.colname)) {
                            os.direction = null;
                        }
                    })
                    let key = e.target.path;
                    let direction = e.target.direction;
                    let records = JSON.parse(JSON.stringify(self.mvdata));
                    records.sort(function (a, b) {
                        if (direction === 'asc') {
                            if (moment(a[key], 'DD/MM/YYYY').isBefore(moment(b[key], 'DD/MM/YYYY'))) return -1;
                            if (moment(a[key], 'DD/MM/YYYY').isAfter(moment(b[key], 'DD/MM/YYYY'))) return 1;
                        } else {
                            if (moment(a[key], 'DD/MM/YYYY').isBefore(moment(b[key], 'DD/MM/YYYY'))) return 1;
                            if (moment(a[key], 'DD/MM/YYYY').isAfter(moment(b[key], 'DD/MM/YYYY'))) return -1;
                        }
                        return 0;
                    });

                    self.set('mvdata', records);
                    self.changePage();
                }
            }

            _sortByJubilaeum(e) {
                let self = this;
                if (e.target && e.target.path && e.target.path === 'GEBURTSDATUM' && e.target.direction) {
                    let otherSorter = this.shadowRoot.querySelectorAll('column-sorter');
                    otherSorter.forEach((os) => {
                        if (os.direction && (os.colname !== e.target.colname)) {
                            os.direction = null;
                        }
                    })
                    let key = e.target.path;
                    let direction = e.target.direction;
                    let records = JSON.parse(JSON.stringify(self.mvdata));
                    // for strings
                    records.sort(function (a, b) {
                        if (direction === 'asc') {
                            if (moment((self.getJubilaeumBy(a[key]) || 'Dec'), 'MMM').isBefore(moment((self.getJubilaeumBy(b[key]) || 'Dec'), 'MMM'))) return -1;
                            if (moment((self.getJubilaeumBy(a[key]) || 'Dec'), 'MMM').isAfter(moment((self.getJubilaeumBy(b[key]) || 'Dec'), 'MMM'))) return 1;
                            
                        } else {
                            if (moment((self.getJubilaeumBy(a[key]) || 'Dec'), 'MMM').isBefore(moment((self.getJubilaeumBy(b[key]) || 'Dec'), 'MMM'))) return 1;
                            if (moment((self.getJubilaeumBy(a[key]) || 'Dec'), 'MMM').isAfter(moment((self.getJubilaeumBy(b[key]) || 'Dec'), 'MMM'))) return -1;
                            
                        }
                        return 1;
                    });

                    self.set('mvdata', records);
                    self.changePage();
                }
            }





            changePage() {
                if (this._pageStart || this._pageStart === 0) {
                    let end = parseInt(this._pageStart) + (parseInt(this.pageSize));
                    let newItems = this.mvdata.slice(this._pageStart, end);
                    this.set('mvpagedata', newItems);
                    this.set('openeddetails', [])
                }
            }

            splitToObjects(resp) {
                let paechterData = resp.data;
                let columns = resp.columns;
                let promises = [];

                return Promise.all(promises).then(() => {
                    this.set('columnNames', columns);
                    this.set('mvdata', paechterData);
                    this.set('pageSize', parseInt(10));
                })
            }

            naturalSorter(as, bs) {
                let a, b, a1, b1, i = 0, n, L,
                    rx = /(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;
                if (as === bs) return 0;
                a = as.toLowerCase().match(rx);
                b = bs.toLowerCase().match(rx);
                L = a.length;
                while (i < L) {
                    if (!b[i]) return 1;
                    a1 = a[i],
                        b1 = b[i++];
                    if (a1 !== b1) {
                        n = a1 - b1;
                        if (!isNaN(n)) {
                            return n;
                        }
                        return a1 > b1 ? 1 : -1;
                    }
                }
                return b[i] ? -1 : 0;
            }

            _setLoading(val) {
                this.set('_loading', val);
            }

            _activeChanged(newV, oldV) {
                console.log('selected changed newV:' + newV + " oldV:" + oldV)
                if (newV) {
                    this.$.firstclient.getAsJSON('paechter').then((resp) => {
                        if (resp) {
                            this.splitToObjects(resp).finally(() => {
                                this.changePage();
                            });
                        } else {
                            showToast(this, 'Bei der erneuten Initialisierung der Seite wurden keine Pächterdaten gefunden', TOAST_TYPE.ERROR);
                        }
                    }).catch((err) => {
                        console.log("Fehler beim get fuer Paecheter  kam:" + JSON.stringify(err))
                        showToast(this, 'Die Pächeterdaten konnten nicht geladen werden', TOAST_TYPE.ERROR);
                    })
                }
            }

            _showExportDialog() {
                if (!this.mvdata || !this.mvdata.length) {
                    this.$.grtinfodialog.showDialog(
                        {
                            "title": "Keine Daten",
                            "message": "Es gibt keine Pächterdaten, die man exportieren könnte."
                        })

                } else {
                    this.$.exportdialog.showDialog(
                        {
                            "title": "Speicherort Auswahl",
                            "message": "Bitte wählen Sie ob eine lokale Speicherung erwünscht ist oder eine Speicherung auf dem Server."
                        })
                }
            }

            exportPaechter(e) {
                let dataAndColumns = { data: this.mvdata, columns: this.columnNames }
                this.$.firstclient.exportPaechterAsCSV(dataAndColumns, e.detail).then((savePath) => {
                    if (savePath && savePath.path) {
                        this.$.grtinfodialog.showDialog(
                            {
                                "title": "Daten als CSV - exportieren",
                                "message": "Die Daten der Pächter wurden erfolgreich unter " + savePath.path + " gespeichert."
                            })
                    } else if (savePath) {
                        showToast(this, "Die Daten der Pächter werden unter " + savePath + " gespeichert.", TOAST_TYPE.WARN, 'topRight');
                    }
                }).catch((err) => {
                    showToast(this, 'Der Datenexport der Pächter ist fehlgeschlagen', TOAST_TYPE.ERROR);
                });
            }

            //paechterdata save
            _saveItemData(e) {
                if (e && e.target && e.target.id && !e.target.disabled) {
                    let idxOrigTable = idxActiveTable + (parseInt(this._pageStart) || 0);
                    // das ist och nicht funktionall, siehe versicherte
                    this.set('dosave', idxOrigTable);
                }
                e.stopPropagation();
            }

            _insertChangedPaechter(e) {
                this.splice('mvdata', e.detail.index, 1, e.detail.data)
                this.changePage();
            }

            _insertNewPaechter(e) {
                let self = this;
                self.splice('mvdata', self._pageStart, 0, e.detail);
            }

            _postOneFM(e) {
                let toSave = null;
                if (e.type && e.type === 'savegartler') {
                    toSave = e.detail.data;
                    let mid = e.target.id;
                    toSave = this._removeMetadata(toSave);
                    this.$.firstclient.postAsJSON(toSave, 'foerdermitglieder', toSave.AUFNAHMEDATUM).then(() => {
                        this.$[mid].pushSuccesfullEvent(e.type);
                        this._insertChangedPaechter(e);
                        if (this.logg){
                            let historyID = "history" + mid.substring(4);
                            this.$[historyID].postLogData(toSave, e.detail.logdata, 'foerdermitglieder');
                        }
                        showToast(this, 'Die Änderungen des Pächters wurden erfolgreich gespeichert', TOAST_TYPE.SUCCESS);
                    }).catch((error) => {
                        showToast(this, 'Fehler bei der Speicherung der Änderungen', TOAST_TYPE.ERROR);
                    })
                }
            }

            postPaechter() {
                if (!this.mvdata || !this.mvdata.length) {
                    this.$.grtinfodialog.showDialog(
                        {
                            "title": "Keine Daten",
                            "message": "Es gibt keine Pächterdaten, die man speichern könnte."
                        })

                } else {
                    let dataAndColumns = { data: this.mvdata, columns: this.columnNames }
                    this.$.sandhour.showDialog();
                    this.$.firstclient.postAsJSON(dataAndColumns, 'foerdermitglieder').then(() => {
                        console.log('paechter gespeichert')
                        showToast(this, 'Die Paechter wurden erfolgreich gespeichert', TOAST_TYPE.SUCCESS);
                    }).catch(() => {
                        showToast(this, 'Fehler beim Speichern der Paecheterndaten', TOAST_TYPE.ERROR);
                    }).finally(() => {
                        this.$.sandhour._closeDialog();
                    })

                }
            }

            // check-box and apps
            _isItemSelected(_pageStart, index) {
                let path = 'mvdata.' + (_pageStart + index) + '.selected';
                return this.get(path);
            }

            _noOneSelected() {
                return !this.mvdata.some((data) => data.selected);
            }

            _areAllSelected() {
                return !this.mvdata.some((data) => !data.selected);
            }

            _checkAll(e) {
                if (e.currentTarget.checked) {
                    this.mvdata.forEach((mv, idx) => {
                        let path = 'mvdata.' + idx + '.selected'
                        this.set(path, true)
                    })
                } else {
                    this.mvdata.forEach((mv, idx) => {
                        let path = 'mvdata.' + idx + '.selected'
                        this.set(path, false)
                    })
                }
            }

            getSelected() {
                let thetasks = this.mvdata.filter((el) => el.selected === true);
                return thetasks;
            }

            _checkOne(e) {
                let realIndex = e.target.id.substring(3);
                if (e.currentTarget.checked) {
                    let path = 'mvdata.' + realIndex + '.selected'
                    this.set(path, true)
                } else {
                    let path = 'mvdata.' + realIndex + '.selected'
                    this.set(path, false)
                }
            }

            _showApps(e) {
                this.$.appsdialog.showDialog()
                // iziToast.show({
                //   position: "center",
                //   title: 'Hey',
                //   message: 'What would you like to add?',
                // })
            }

            getGridElementID(index, _pageStart, prefix) {
                let realIndex = (parseInt(index) + parseInt(_pageStart));
                return prefix + realIndex;
            }

            //css and dynamic elements
            isSaveAllDisabled() {
                if (!this._isAenderung || (this.openeddetails && this.openeddetails.length) || !this.mvdata || !this.mvdata.length) {
                    return true;
                } else
                    return false;
            }

            isExportDisabled() {
                if ((this.openeddetails && this.openeddetails.length) || !this.mvdata || !this.mvdata.length) {
                    return true;
                } else return false;
            }

            getClassByBeitrag(beitrag) {
                if (!beitrag || beitrag.length === 0) {
                    return ".redc";
                } else return ".redc";
            }

            getIcon(detailsOpened) {
                if (detailsOpened) {
                    return 'close';
                } else return 'create';
            }

            _removeItem(confirmEvent) {
                let id = confirmEvent.detail.substring(0, confirmEvent.detail.indexOf('-'));
                let elem = this.mvdata.find((v) => {
                    return v.GARTENNUMMER === id;
                });
                let idx = this.mvdata.indexOf(elem);
                if (idx >= 0) {
                    this.$.firstclient.deleteOne('foerdermitglieder', elem.GARTENNUMMER).then(() => {
                        this.splice('mvdata', idx, 1);
                        showToast(this, 'Der Pächter wurde erfolgreich gelöscht', TOAST_TYPE.SUCCESS);
                    }).catch(() => {
                        showToast(this, 'Fehler bei der Löschung des Pächters. Versuchen Sie später noch einmal.', TOAST_TYPE.ERROR);
                    })
                } else if (!elem && idx === -1) {
                    // ist ein fehlerhafter Datensatz ohne Gartennummer, womöglich aus einer leeren Zeile der Importdatei
                    const rowIdx = id.substring(1); // ab dem minus-Zeichen, befindet sich die Zeilenindex
                    this.$.firstclient.deleteOne('foerdermitglieder', null).then(() => {
                        this.splice('mvdata', rowIdx, 1);
                        showToast(this, 'Der Pächter wurde erfolgreich gelöscht', TOAST_TYPE.SUCCESS);
                    }).catch(() => {
                        showToast(this, 'Fehler bei der Löschung des Pächters. Versuchen Sie später noch einmal.', TOAST_TYPE.ERROR);
                    })
                }
            }

            addPaecheter() {
                // this.$.adddialog.showDialog();
            }

            getAlterBy(geburtsdatum) {
                let years = null;
                if (geburtsdatum) {
                    let gdatMoment = moment(geburtsdatum, 'DD/MM/YYYY');
                    years = moment().diff(gdatMoment, 'years');
                }
                return years;
            }

            getJubilaeumBy(geburtsdatum) {
                let years = null;
                let jmonat = null;
                if (geburtsdatum) {
                    let gdatMoment = moment(geburtsdatum, 'DD/MM/YYYY');
                    years = moment().diff(gdatMoment, 'years');
                    if (!(years % 10) || (years > 50 && !(years % 5))) {
                        console.log('years % 10' + (years % 10) + ' years' + years)
                        console.log('(years % 5)' + (years % 5) + ' years' + years)
                        jmonat = gdatMoment.format('MMM')
                    }
                }
                return jmonat;
            }
        }

        window.customElements.define(MyFoerdermitglieder.is, MyFoerdermitglieder);
    </script>
</dom-module>