<!--
Die Versicherten-Seite
Auf dieser Seite werden nur die Pächter dargestellt die eine Versicherung abgeschlossen haben.
Diese kann beim KVD oder bei einer externen Versicherungsgesellschaft abgeschlossen sein.
Ein bisher Versicherter der nicht mehr bezahlt hat, wird zuerst telefonisch, per E-Mail oder per Brief erinnert.

Wenn für diesen Pächter keine Zahlung und keinen Versicherungsnachweis erfasst wurden, OBWOHL für ihn die Erinnerungsversuche
unternommen wurden, wird dieser:

  - authomatisch vom System nach 14 Tagen nach dem Erinnerungskontakt; 
  - manuell durch den Versicherungsbeauftragten;

in die Liste der "nicht versicherten" verschoben. Die Verschiebung in die Liste der anzumahnenden Pächter setzt
zwingend voraus, dass der Versicherungsbeauftragter die Erinnerungsversuche unternommen und protokolliert hat.

Für die nicht - versicherten Pächter wird eine Benachrichtigungs-EMail an den Verein samt einem 
an der E-Mail angehängten Mahnungs-Anschreiben verschickt. Die E-Mail an den Verein enthält zwingend
die Informationen über die nicht erfolgreichen Versuche, ihn zur Zahlung zu bewegen.
Der 14-Tage Frist kann vom Versicherungsbeauftragten auf maximal 1 Monat verlängert werden.

***********************************************
Entstehung und Änderungen der Versichertenliste
***********************************************
Die Versichertenliste entsteht initial durch das Importieren der Versichertenbestand aus der CSV-Datei vom KVD.
Weiterhin, kann der Benutzer, manuell durch die Bearbeitung der "nicht verischerten" Liste, einzelne "nicht Verischerte"
in die Versichertenliste verschieben. Dabei musste er die Informationen über den letzten gültigen Zahlungseing erfasst haben
(eingezahlten Zahlungsbetrag, Datum, Vericherungsoptionen(FED usw)).

Man kann Einträge aus dieser Liste in die Nicht-Versicherten-Liste verschieben oder ganz Löschen.
Eine Löschung aus der Versichertenliste führt nicht zu einer tatsächlichen Löschung, sondern in die Verschiebung der 
Daten in einer Versicherten-Passivliste, denn es könnte durchaus sein, dass man uach nach einer Kündigung die 
Daten über die Versicherung noch braucht. Die Einträge in der Passivliste werden vom System nach 2 Jahren aus der Liste entfernt.
Ab diesem Zeitpunkt kennt das System keine Informationen mehr über die versicherte Person.


-->

<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-progress-button/paper-progress-button.html">
<link rel="import" href="../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/datetime-picker/overlay-date-picker.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../second-domain-styles.html">
<link rel="import" href="../table-styles.html">
<link rel="import" href="../clients/firstclient.html">
<link rel="import" href="../clients/basicclient.html">

<link rel="import" href="../general/my-versicherungrechner.html">
<link rel="import" href="../utils/grt-grid-pagination.html">
<link rel="import" href="../utils/export-chooser.html">
<link rel="import" href="../utils/grt-dialog.html">
<link rel="import" href="../utils/apps-dialog.html">
<link rel="import" href="../utils/column-sorter.html">



<dom-module id="my-versicherte">
  <template>
    <style include="second-domain-styles table-styles">
      :host {
        /* Stretch this element to fill viewport */
        height: calc(100vh - 88px);
        flex: 1;

        /* Make a flex column layout of children */
        display: flex;
        flex-direction: column;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        padding: var(--content-padding);
      }

      .toolbar {
        /* height: 40px; */
        padding: 5px;
        /*line-height: 32px;*/
        background: #eee;
      }

      iron-collapse-button {
        cursor: cursor;
        padding-right: 12px;
      }

      iron-collapse-button div[slot="collapse-trigger"] {
        height: 48px;
        line-height: 48px;
      }

      iron-collapse-button div[slot="collapse-content"] {
        margin-right: -12px;
      }

      paper-button {
        padding: 0.2em 0.5em 0.2em 0.5em !important;
      }

      .button {
        padding: 0px 2px 0px 2px !important;
      }

      .rightalign {
        text-align: right !important;
      }

      .centered-cell {
        text-align: center !important;
        vertical-align: middle !important;
      }

      .versichert {
        background-color: #f5f5f5 !important;
      }

      .gefaehrdet {
        background-color: yellow !important;
      }

      .nichtversichert {
        background-color: orangered !important;
      }
    </style>

    <first-client id="firstclient"></first-client>
    <basic-client id="bclient"></basic-client>
    <grt-dialog id="deletedialog" dialog-type="confirmation" confirmation-name="Löschen" cancel-name="Abbrechen"
      on-grtconfirm="_removeItem"></grt-dialog>
    <grt-dialog id="grtinfodialog" dialog-type="info"></grt-dialog>
    <export-chooser id="exportdialog" dialog-type="info" confirmation-name="Schließen"
      on-export-data="exportVersicherte"></export-chooser>
    <apps-dialog id="appsdialog" action-buttons="[[actionButtons]]" tasks="[[getSelected(mvdata.*)]]"></apps-dialog>
    <div>
      <div class="toolbar layout horizontal justified" flex>
        <template is="dom-if" if="[[spaltenConf.columns.length]]">
          <grt-grid-pagination id="pagesss" datalength="[[mvdata.length]]" page-size="{{pageSize}}"
            pstart="{{_pageStart}}" on-pagechanged="changePage" style-domain="second-domain">
          </grt-grid-pagination>
        </template>
        <div class="layout horizontal justified" flex="50">
          <button id="appsbutton" on-click="_showApps" disabled="[[_noOneSelected(mvdata.*)]]" class="action-button">
            <iron-icon icon="apps" id="appsicon" slot="item-icon" on-click="_showApps"></iron-icon>
          </button>
          <paper-button disabled="[[isExportDisabled(mvdata.*, openeddetails.*)]]" bottom raised
            on-click="_showExportDialog">Exportieren</paper-button>
        </div>
      </div>
      <div class="demo">
        <div class="table-responsive-vertical shadow-z-1">
          <table id="table" class="table table-condensed table-hover">
            <thead>
              <th class="centered-cell">
                <paper-checkbox on-change="_checkAll" checked="[[_areAllSelected(mvdata.*)]]"></paper-checkbox>
              </th>
              <template is="dom-repeat" items="[[spaltenConf.columns]]" as="sc1">
                <template is="dom-if" if="[[sc1.th_show]]">
                  <th>
                    <column-sorter id="[[sc1.colname]]" colname="[[sc1.alias]]" path="[[sc1.colname]]"
                      coltype="[[sc1.coltype]]" on-sorter-changed="_sortChange">
                    </column-sorter>
                  </th>
                </template>
              </template>
              <th class="button"></th>
            </thead>
            <tbody>
              <template is="dom-repeat" items="[[mvpagedata]]" as="vs">
                <tr class$="[[vs.versicherung.status]]">
                  <td class="centered-cell">
                    <paper-checkbox class="[[getClassByBeitrag(vs.BEITRAG)]]"
                      id="[[getGridElementID(index, _pageStart, 'scb')]]" on-change="_checkOne"
                      checked="[[_isItemSelected(_pageStart, index, mvdata.*)]]"></paper-checkbox>
                  </td>
                  <!-- <td class="rightalign">[[item.GARTENNUMMER]]</td>
                  <td>[[item.NACHNAME]]</td>
                  <td>[[item.VORNAME]]</td>
                  <template is="dom-if" if="[[!_externeVersicherung(item.versicherung.name)]]">
                    <td class="rightalign">[[item.GBV]]</td>
                    <td class="rightalign">[[item.FED]]</td>
                    <td class="rightalign">[[item.HOEV]]</td>
                    <td class="rightalign">[[item.A7_1]]</td>
                    <td class="rightalign">[[item.A7_3]]</td>
                    <td class="rightalign">[[item.A7_4]]</td>
                    <td class="rightalign">[[item.UV]]</td>
                    <td class="rightalign">[[item.BEITRAG]]</td>
                  </template>
                  <template is="dom-if" if="[[_externeVersicherung(item.versicherung.name)]]">
                    <th colspan="8" class="centered-cell">[[item.versicherung.name]]</th>
                  </template> -->

                  <template is="dom-repeat" items="[[spaltenConf.columns]]" as="sc2">
                    <template is="dom-if" if="[[sc2.th_show]]">
                      <td class$="[[getClassByColtype(sc2.coltype)]]">[[_getVSData(vs, sc2)]]</td>
                    </template>
                  </template>
                  <td class="button">
                    <button id="bto[[vs.GARTENNUMMER]]" on-click="_openDetails"
                      class="second-domain-endpagebutton action-button">
                      <iron-icon id="cro[[vs.GARTENNUMMER]]" icon="[[getIcon(vs._detailsOpened)]]" slot="item-icon"
                        on-click="_openDetails"></iron-icon>
                    </button>
                  </td>
                </tr>
                <template is="dom-if" if="[[vs._detailsOpened]]">
                  <tr class="details">
                    <td colspan="13" class="no-padding">
                      <iron-collapse-button expand-icon="add-circle-outline" collapse-icon="remove-circle-outline"
                        class="detailelement light-element flex" opened>
                        <div slot="collapse-trigger" class="flex">
                          <div class="layout horizontal justified">
                            <span>Daten des Versicherungnehmers</span>
                          </div>
                        </div>
                        <div slot="collapse-content" class="corrected-margin">
                          <div class="mcard strong-text-color">
                            <grt-member id="mmbr[[_pageStart]]-[[index]]" id-key="GARTENNUMMER" member="[[vs]]"
                              col-conf="[[spaltenConf]]" read-only="true">
                              <h4 slot="title">Fördermitglied</h4>>
                            </grt-member>
                          </div>
                        </div>
                      </iron-collapse-button>
                    </td>
                  </tr>
                  <tr class="details">
                    <td colspan="14" class="no-padding">
                      <iron-collapse-button expand-icon="add-circle-outline" collapse-icon="remove-circle-outline"
                        class="detailelement light-element flex" opened>
                        <div slot="collapse-trigger" class="flex">
                          <div class="layout horizontal justified">
                            <span>Versicherungsdaten</span>
                            <button id="sbt[[index]]" on-click="_saveItemData"
                              disabled="[[_saveButtonDisabled(dc, vs.versicherung.name, vs.versicherung.von, vs.versicherung.bis)]]">
                              <iron-icon icon="save" id="sic[[index]]" slot="item-icon"
                                disabled="[[_saveButtonDisabled(dc, vs.versicherung.name, vs.versicherung.von, vs.versicherung.bis)]]"
                                on-click="_saveItemData"></iron-icon>
                            </button>
                          </div>
                        </div>

                        <div slot="collapse-content" class="corrected-margin">
                          <div class="mcard strong-text-color">
                            Versicherer: <paper-input id="versName[[index]]" value="[[vs.versicherung.name]]"
                              on-value-changed="_doOnVersicherungNameChanged"></paper-input>
                            Von: <overlay-date-picker id="versVon[[index]]" date="{{vs.versicherung.von}}" required
                              on-value-changed="_doOnVersicherungVonChanged"></overlay-date-picker>
                            <!-- <paper-input id="versVon[[index]]" value="[[item.versicherung.von]]"
                              on-value-changed="_doOnVersicherungVonChanged"></paper-input> -->
                            Bis: <overlay-date-picker id="versBis[[index]]" date="{{vs.versicherung.bis}}" required
                              on-value-changed="_doOnVersicherungBisChanged"></overlay-date-picker>

                            <!--<paper-input id="versBis[[index]]" value="[[item.versicherung.bis]]"
                              on-value-changed="_doOnVersicherungBisChanged"></paper-input>-->
                          </div>
                        </div>
                        <template is="dom-if" if="[[_isKVDVersichert(vs.versicherung.name)]]">
                          <div slot="collapse-content" class="corrected-margin">
                            <div class="mcard strong-text-color">
                              <my-versicherungrechner id="[[getGridElementID(index, _pageStart, 'vrd')]]"
                                vcs="[[vconfig]]" saved-data="[[vs]]" dosave="{{dosave}}" changed-saved-data="{{dc}}"
                                on-savedversicherter="_postOnePaechter"></my-versicherungrechner>
                            </div>
                          </div>
                        </template>
                      </iron-collapse-button>
                    </td>
                  </tr>
                </template>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </template>

  <script>
    class MyVersicherte extends Polymer.Element {
      static get is() { return 'my-versicherte'; }

      static get properties() {
        return {
          actionButtons: {
            type: Array,
            value: ['email', 'rechnung', 'meldung', 'brief']
          },

          pageSize: {
            type: Number,
            value: null,
            notify: true,
            observer: 'changePage'
          },

          _pageStart: {
            type: Number,
            value: 0
          },

          _loading: {
            type: Boolean,
            value: false
          },

          mvdata: {
            type: Array,
            value: [],
            notify: true,
            reflectToAttribute: true
          },

          mvpagedata: {
            type: Array,
            value: [],
            notify: true,
            reflectToAttribute: true
          },

          _pages: {
            type: Object,
            value: null
          },

          selected: {
            type: Boolean,
            value: false,
            observer: '_activeChanged',
          },

          columnNames: {
            type: Array,
            value: []
          },

          vconfig: {
            type: Object,
            value: null,
            notify: true
          },

          openeddetails: {
            type: Array,
            value: []
          },

          dosave: {
            type: Boolean,
            value: null,
            notify: true
          },
          dc: {
            type: Boolean,
            value: null,
            notify: true
          },

          spaltenConf: {
            type: Array,
            value: null,
            notify: true,
            observer: '_spaltenConfReady'
          },

          _defaultColumnConf: {
            type: Object,
            value: {
              "column_groups": [
                "Garten",
                "Pächter",
                "Anschrift",
                "Kontakt",
                "Details",
                "GBV",
                "FED",
                "Zusatzversicherung",
                "Unfall",
                "Beitrag",
                "Bemerkung"
              ],
              "columns": [
                {
                  "colname": "GARTENNUMMER",
                  "coltype": "numberstring",
                  "alias": "GNr",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "1",
                  "gruppen_position": "1",
                  "th_show": true,
                  "gruppe": "Garten"
                },
                {
                  "colname": "ANREDE",
                  "coltype": "string",
                  "alias": "Anrede",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "1",
                  "gruppe": "Pächter",
                  "th_show": false
                },
                {
                  "colname": "NACHNAME",
                  "coltype": "string",
                  "alias": "Nachname",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "2",
                  "gruppen_position": "2",
                  "gruppe": "Pächter",
                  "th_show": true
                },
                {
                  "colname": "VORNAME",
                  "coltype": "string",
                  "alias": "Vorname",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "3",
                  "gruppen_position": "3",
                  "gruppe": "Pächter",
                  "th_show": true
                },
                {
                  "colname": "STRASSE",
                  "coltype": "string",
                  "alias": "Strasse",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "",
                  "gruppen_position": "1",
                  "gruppe": "Anschrift"
                },
                {
                  "colname": "PLZ",
                  "coltype": "string",
                  "alias": "PLZ",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "3",
                  "gruppe": "Anschrift",
                  "th_show": false
                },
                {
                  "colname": "WOHNORT",
                  "coltype": "string",
                  "alias": "Wohnort",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "",
                  "gruppen_position": "4",
                  "gruppe": "Anschrift"
                },
                {
                  "colname": "TELEFON",
                  "coltype": "string",
                  "alias": "Telefon",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "",
                  "gruppen_position": "1",
                  "gruppe": "Kontakt"
                },
                {
                  "colname": "WEG",
                  "coltype": "string",
                  "alias": "Weg",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "2",
                  "gruppe": "Garten",
                  "th_show": false
                },
                {
                  "colname": "FLAECHE",
                  "coltype": "number",
                  "alias": "Fläche",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "",
                  "gruppen_position": "3",
                  "gruppe": "Garten"
                },
                {
                  "colname": "GEBURTSDATUM",
                  "coltype": "date",
                  "alias": "Geburtsdatum",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "4",
                  "gruppe": "Pächter",
                  "th_show": false
                },
                {
                  "colname": "EMAIL",
                  "coltype": "string",
                  "alias": "E-Mail",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "2",
                  "gruppe": "Kontakt",
                  "th_show": false
                },
                {
                  "colname": "BEMERKUNGEN",
                  "coltype": "longstring",
                  "alias": "Bemerkung",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "",
                  "gruppen_position": "1",
                  "gruppe": "Details"
                },
                {
                  "colname": "HAUSNUMMER",
                  "coltype": "numberstring",
                  "alias": "HausNr",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": "",
                  "gruppen_position": "2",
                  "gruppe": "Anschrift"
                },
                {
                  "colname": "ALTER",
                  "coltype": "number",
                  "alias": "Alter",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "5",
                  "gruppe": "Pächter",
                  "th_show": false
                },
                {
                  "colname": "JUBILAEUM",
                  "coltype": "date",
                  "alias": "Jubiläum",
                  "rolen": [
                    "paechter",
                    "versicherung"
                  ],
                  "position": null,
                  "gruppen_position": "6",
                  "gruppe": "Pächter",
                  "th_show": false
                },
                {
                  "colname": "GBV",
                  "coltype": "number",
                  "alias": "GBV",
                  "rolen": [],
                  "position": "4",
                  "gruppen_position": "1",
                  "th_show": true,
                  "gruppe": "GBV"
                },
                {
                  "colname": "FED",
                  "coltype": "number",
                  "alias": "FED",
                  "rolen": [],
                  "position": "5",
                  "gruppen_position": "1",
                  "th_show": true,
                  "gruppe": "FED"
                },
                {
                  "colname": "HOEV",
                  "coltype": "number",
                  "alias": "HöV",
                  "rolen": [],
                  "position": "6",
                  "gruppen_position": "2",
                  "th_show": true,
                  "gruppe": "FED"
                },
                {
                  "colname": "A7_1",
                  "coltype": "number",
                  "alias": "SA",
                  "rolen": [],
                  "position": "7",
                  "gruppen_position": "1",
                  "th_show": true,
                  "gruppe": "Zusatzversicherung"
                },
                {
                  "colname": "A7_3",
                  "coltype": "number",
                  "alias": "A 73",
                  "rolen": [],
                  "position": "8",
                  "gruppen_position": "2",
                  "th_show": true,
                  "gruppe": "Zusatzversicherung"
                },
                {
                  "colname": "A7_4",
                  "coltype": "number",
                  "alias": "Solar",
                  "rolen": [],
                  "position": "9",
                  "gruppen_position": "3",
                  "th_show": true,
                  "gruppe": "Zusatzversicherung"
                },
                {
                  "colname": "UV",
                  "coltype": "number",
                  "alias": "UV",
                  "rolen": [],
                  "position": "10",
                  "gruppen_position": "1",
                  "th_show": true,
                  "gruppe": "Unfall"
                },
                {
                  "colname": "BEITRAG",
                  "coltype": "number",
                  "alias": "Beitrag",
                  "rolen": [],
                  "position": "11",
                  "gruppen_position": "1",
                  "th_show": true,
                  "gruppe": "Beitrag"
                },
                {
                  "colname": "V_BEMERKUNG",
                  "coltype": "longstring",
                  "alias": "Bemerkung",
                  "rolen": [],
                  "position": "",
                  "gruppen_position": "1",
                  "gruppe": "Bemerkung"
                }
              ]
            }
          }

        }
      }

      _getVSData(fm, spalte) {
        if (spalte.coltype === "date") {
          let res = moment(fm[spalte.colname]);
          if (res.isValid()) {
            return res.format('DD.MM.YYYY HH:mm');
          } else return fm[spalte.colname];
        } else
          return fm[spalte.colname];
      }

      _spaltenConfReady() {
        if (this.spaltenConf && this.spaltenConf.columns && this.spaltenConf.columns.length) {
          this.$.firstclient.getAsJSON('paechter').then((resp) => {
            if (resp) {
              resp = this.setVersicherungstatus(resp);
              this.splitToObjects(resp).finally(() => {
                //wenn pageSize nur an einer stelle initialisiert wird (in then von splitToObjects)
                // dann der gleiche wert 10 wird nicht noch mal zu der pagination Componente getriggert
                // denn er sich noch nicht geändert hatte, die Komp beim ersten mal aber nicht da war
                this.set('pageSize', parseInt(0));
                this.changePage();
              });
            } else {
              showToast(this, 'Bei der Initialisierung der Seite wurden keine Versicherte gefunden', TOAST_TYPE.ERROR);
            }
          }).catch((err) => {
            console.log("Fehler beim get fuer versicherte  kam:" + JSON.stringify(err))
            showToast(this, 'Die Versicherten konnten nicht geladen werden', TOAST_TYPE.ERROR);
          })
        }
      }

      _cleanKVDInfos(versicherter) {
        const keysToReset = ["GBV", "FED", "HOEV", "A7_1", "A7_3", "A7_4", "UV", "BEITRAG"];
        Object.keys(versicherter).forEach((vkey) => {
          if (keysToReset.some((elem) => elem === vkey)) {
            versicherter[vkey] = null;
          }
        })
        return versicherter;
      }

      _removeMetadata(versicherter) {
        let vToSave = JSON.parse(JSON.stringify(versicherter))
        const keysToReset = ["_detailsOpened"];
        Object.keys(vToSave).forEach((vkey) => {
          if (keysToReset.some((elem) => elem === vkey)) {
            delete vToSave[vkey];
          }
        })
        return vToSave;
      }

      _doOnVersicherungNameChanged(e) {

        if (e && e.target) {
          let realIdx = e.target.id.substring(8);
          let path = 'mvpagedata.' + realIdx + '.versicherung.name';
          this.set(path, e.target.__data.value)
          this.set('dc', true)
        }
      }
      _doOnVersicherungVonChanged(e) {

        if (e && e.target) {
          // let realIdx = e.target.id.substring(7);
          // let path = 'mvpagedata.' + realIdx + '.versicherung.von';
          // this.set(path, e.target.__data.value)
          console.warn('changeevent for von')
          this.set('dc', true)
        }
      }
      _doOnVersicherungBisChanged(e) {
        if (e && e.target) {
          // let realIdx = e.target.id.substring(7);
          // let path = 'mvpagedata.' + realIdx + '.versicherung.bis';
          // this.set(path, e.target.__data.value)
          this.set('dc', true)
        }
      }

      _saveButtonDisabled(dc, versName, von, bis) {
        return (versName === "KVD" && !dc) || !versName || !von || !bis;
      }

      _isKVDVersichert(name) {
        return name === 'KVD';
      }

      _externeVersicherung(name) {
        if (name && name !== 'KVD') {
          return true
        }
        return false;
      }

      ready() {
        super.ready();

        if (this.$)
          this.$ = new Proxy(this.$, {
            get: ($, id) => $[id] || this.shadowRoot.getElementById(id),
            set: ($, id, element) => {
              $[id] = element;
              return true;
            }
          });
        this._loadColumnConfigThenData();
        window.addEventListener('vconfigchanged', (e) => {
          console.warn('vconfigchanged in versicherte' + JSON.stringify(e.detail))
          this.set('vconfig', e.detail);
        })
      }

      _loadColumnConfigThenData() {
        this.$.bclient.getDomaenenColumnConfig('versicherte').then((domConf) => {
          if (!domConf || !domConf.columns || !Array.isArray(domConf.columns)) {
            throw 'nicht gefunden';
          } else {
            domConf.columns.sort((a, b) => {
              return (a.th_show && a.postion && !isNaN(a.position) && b.th_show && b.position && !isNaN(b.position) && parseInt(a.position) < parseInt(b.position) ? 1 : -1)
            })
            console.warn('conf ist' + JSON.stringify(domConf))
            this.set('spaltenConf', domConf);
            showToast(this, 'Die Versicherten-Spaltenkonfiguration wurde erfolgreich geladen', TOAST_TYPE.SUCCESS);
          }

        }).catch((err) => {
          console.warn('conf column  err' + err)
          this._defaultColumnConf.columns.sort((a, b) => {
            return (a.th_show && a.postion && !isNaN(a.position) && b.th_show && b.position && !isNaN(b.position) && parseInt(a.position) < parseInt(b.position) ? 1 : -1)
          })
          console.warn('default conf ist' + JSON.stringify(this._defaultColumnConf))
          this.set('spaltenConf', this._defaultColumnConf);
          showToast(this, 'Keine Spaltenkonfiguration für die FM konnte geladen werden, default wird benutzt', TOAST_TYPE.ERROR);
        })
      }

      _openDetails(e) {
        e.model.set("vs._detailsOpened", !e.model.vs._detailsOpened);
        if (e.model.vs._detailsOpened) {
          this.push('openeddetails', true);
        } else {
          this.shift('openeddetails');
        }
        e.stopPropagation();
      }

      _sortChange(e) {
        let self = this;
        if (e.target && e.target.path && e.target.direction) {
          let otherSorter = this.shadowRoot.querySelectorAll('column-sorter');
          otherSorter.forEach((os) => {
            if (os.direction && (os.colname !== e.target.colname)) {
              os.direction = null;
            }
          })
          let key = e.target.path;
          let direction = e.target.direction;
          let coltype = e.target.coltype;
          let records = JSON.parse(JSON.stringify(self.mvdata));
          switch (coltype) {
            case 'numberstring':
              records = this._alphaNumbersSorter(self, records, direction, key);
              break;
            case 'number':
              records = this._numbersSorter(records, direction, key);
              break;
            case 'string':
              records = this._stringsSorter(records, direction, key);
              break;
            default:
              records = this._stringsSorter(records, direction, key);
              break;
          }
          self.set('mvdata', records);
          self.changePage();
        }
      }

      _alphaNumbersSorter(self, records, direction, key) {
        records = records.sort((o1, o2) => {
          let result = self.naturalSorter((o1[key] || "0"), (o2[key] || "0"));
          if (direction === 'asc') {
            return (result < 0) ? -1 : 1;
          } else {
            return (result < 0) ? 1 : -1;
          }
          return 0;
        });
        return records;
      }

      _numbersSorter(records, direction, key) {
        console.warn('aufgerufen')
        records.sort((a, b) => {
          if (direction === 'asc') {
            if ((a[key] || 0) < (b[key] || 0)) return -1;
            if ((a[key] || 0) > (b[key] || 0)) return 1;
          } else {
            if ((a[key] || 0) < (b[key] || 0)) return 1;
            if ((a[key] || 0) > (b[key] || 0)) return -1;
          }
          return 0;
        });
        console.warn('beendet')
        return records;
      }

      _stringsSorter(records, direction, key) {
        records.sort((a, b) => {
          if (direction === 'asc') {
            if ((a[key] || "").toLowerCase() < (b[key] || "").toLowerCase()) return -1;
            if ((a[key] || "").toLowerCase() > (b[key] || "").toLowerCase()) return 1;
          } else {
            if ((a[key] || "").toLowerCase() < (b[key] || "").toLowerCase()) return 1;
            if ((a[key] || "").toLowerCase() > (b[key] || "").toLowerCase()) return -1;
          }
          return 0;
        });
        return records;
      }

      changePage() {
        if (this._pageStart || this._pageStart === 0) {
          let end = parseInt(this._pageStart) + (parseInt(this.pageSize));
          let newItems = this.mvdata.slice(this._pageStart, end);
          this.set('mvpagedata', newItems);
          this.set('openeddetails', [])
        }
      }

      splitToObjects(resp) {
        let versichertenData = resp;
        let columns = resp.columns;
        let promises = [];

        return Promise.all(promises).then(() => {
          this.set('columnNames', columns);
          this.set('mvdata', versichertenData);
          this.set('pageSize', parseInt(10));
        })
      }

      naturalSorter(as, bs) {
        let a, b, a1, b1, i = 0, n, L,
          rx = /(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;
        if (as === bs) return 0;
        a = as.toLowerCase().match(rx);
        b = bs.toLowerCase().match(rx);
        L = a.length;
        while (i < L) {
          if (!b[i]) return 1;
          a1 = a[i],
            b1 = b[i++];
          if (a1 !== b1) {
            n = a1 - b1;
            if (!isNaN(n)) {
              return n;
            }
            return a1 > b1 ? 1 : -1;
          }
        }
        return b[i] ? -1 : 0;
      }

      _setLoading(val) {
        this.set('_loading', val);
      }

      _activeChanged(newV, oldV) {
        console.log('selected changed newV:' + newV + " oldV:" + oldV)
        if (newV) {
          this.$.firstclient.getAsJSON('paechter').then((resp) => {
            if (resp) {
              resp = this.setVersicherungstatus(resp);
              //this.set('pageSize', 10);
              this.splitToObjects(resp).finally(() => {
                this.changePage();
              });
            } else {
              showToast(this, 'Bei der erneuten Initialisierung der Seite wurden keine Versichertendaten gefunden', TOAST_TYPE.ERROR);
            }
          })
        }
      }

      _showExportDialog() {
        if (!this.mvdata || !this.mvdata.length) {
          this.$.grtinfodialog.showDialog(
            {
              "title": "Keine Daten",
              "message": "Es gibt keine Versichertendaten, die man exportieren könnte."
            })

        } else {
          this.$.exportdialog.showDialog(
            {
              "title": "Speicherort Auswahl",
              "message": "Bitte wählen Sie ob eine lokale Speicherung erwünscht ist oder eine Speicherung auf dem Server."
            })
        }
      }

      setVersicherungstatus(data) {
        let newData = [];
        data.forEach((paechter) => {
          newData.push(this._setStatusForOneVersicherter(paechter));
        })
        return newData;
      }

      _setStatusForOneVersicherter(paechter) {
        paechter['versicherung'] = (paechter['versicherung'] || { 'status': null })
        if (!paechter.versicherung.name || !paechter.versicherung.bis || moment().isAfter(moment(paechter.versicherung.bis))) {
          paechter.versicherung['status'] = 'nichtversichert';
        } else if (moment(paechter.versicherung.bis).diff(moment(), 'days') < 45) {
          paechter.versicherung['status'] = 'gefaehrdet';
        } else if (moment().isBefore(moment(paechter.versicherung.bis))) {
          paechter.versicherung['status'] = 'versichert';
        }
        return paechter
      }

      exportVersicherte(e) {
        let dataAndColumns = { data: this.mvdata, columns: this.spaltenConf.columns }
        this.$.firstclient.exportVersicherteAsCSV(dataAndColumns, e.detail).then((savePath) => {
          if (savePath && savePath.path) {
            this.$.grtinfodialog.showDialog(
              {
                "title": "Daten als CSV - exportieren",
                "message": "Die Daten der Versicheten wurden erfolgreich unter " + savePath.path + " gespeichert."
              })
          } else if (savePath) {
            showToast(this, "Die Daten der Versicheten werden unter " + savePath + " gespeichert.", TOAST_TYPE.WARN, 'topRight');
          }
        }).catch((err) => {
          showToast(this, 'Der Datenexport der Versicherten ist fehlgeschlagen', TOAST_TYPE.ERROR);
        });
      }

      //versicherungsdata save
      _saveItemData(e) {

        if (e && e.target && e.target.id && !e.target.disabled) {
          let idxActiveTable = parseInt(e.target.id.substring(3));
          let idxOrigTable = idxActiveTable + (parseInt(this._pageStart) || 0);

          if (this.mvpagedata[idxActiveTable].versicherung.name !== 'KVD') {
            let toSave = this._cleanKVDInfos(this.mvpagedata[idxActiveTable]);
            let elike = { "type": "savedversicherter", "detail": { "data": toSave, "index": idxOrigTable } }
            this._postOnePaechter(elike)
          } else {
            this.set('dosave', idxOrigTable);
          }
        }
        e.stopPropagation();
      }

      _postOnePaechter(e) {
        let toSave = null;
        if (e.type && e.type === 'add-v') {
          toSave = e.detail;
        } else if (e.type && e.type === 'savedversicherter') {
          toSave = e.detail.data;
        }
        toSave = this._setStatusForOneVersicherter(toSave);
        toSave = this._removeMetadata(toSave);
        this.$.firstclient.postAsJSON(toSave, 'paechter', toSave.GARTENNUMMER).then(() => {
          if (e.type && e.type === 'add-v') {
            this._insertNewVersicherter(e);
          } else if (e.type && e.type === 'savedversicherter') {
            this._insertChangedVersicherter(e);
          }
          showToast(this, 'Die Änderungen des Versicherten wurden erfolgreich gespeichert', TOAST_TYPE.SUCCESS);

        }).catch((error) => {
          showToast(this, 'Fehler bei der Speicherung der Änderungen', TOAST_TYPE.ERROR);
          this.set('dosave', null);
        })

      }

      _insertChangedVersicherter(e) {
        this.splice('mvdata', e.detail.index, 1, e.detail.data)
        // self.set('originaldata', self.vc);
        this.set('dosave', null);
        this.changePage();
        this.notifyPath('mvpagedata.' + (parseInt(e.detail.index) - (parseInt(this._pageStart) || 0)) + '.versicherung.status')
      }

      _insertNewVersicherter(e) {
        let self = this;
        self.splice('mvdata', self._pageStart, 0, e.detail);
      }


      // check-box and apps
      _isItemSelected(_pageStart, index) {
        let path = 'mvdata.' + (_pageStart + index) + '.selected';
        return this.get(path);
      }

      _noOneSelected() {
        return !this.mvdata.some((data) => data.selected);
      }

      _areAllSelected() {
        return !this.mvdata.some((data) => !data.selected);
      }

      _checkAll(e) {
        if (e.currentTarget.checked) {
          this.mvdata.forEach((mv, idx) => {
            let path = 'mvdata.' + idx + '.selected'
            this.set(path, true)
          })
        } else {
          this.mvdata.forEach((mv, idx) => {
            let path = 'mvdata.' + idx + '.selected'
            this.set(path, false)
          })
        }
      }

      getSelected() {
        let thetasks = this.mvdata.filter((el) => el.selected === true);
        return thetasks;
      }

      _checkOne(e) {
        let realIndex = e.target.id.substring(3);
        if (e.currentTarget.checked) {
          let path = 'mvdata.' + realIndex + '.selected'
          this.set(path, true)
        } else {
          let path = 'mvdata.' + realIndex + '.selected'
          this.set(path, false)
        }
      }

      _showApps(e) {
        this.$.appsdialog.showDialog()
        // iziToast.show({
        //   position: "center",
        //   title: 'Hey',
        //   message: 'What would you like to add?',
        // })
      }

      getGridElementID(index, _pageStart, prefix) {
        let realIndex = (parseInt(index) + parseInt(_pageStart));
        return prefix + realIndex;
      }

      //css and dynamic elements
      isSaveDisabled() {
        if ((this.openeddetails && this.openeddetails.length) || !this.mvdata || !this.mvdata.length) {
          return true;
        } else return false;
      }

      isExportDisabled() {
        if ((this.openeddetails && this.openeddetails.length) || !this.mvdata || !this.mvdata.length) {
          return true;
        } else return false;
      }

      getClassByBeitrag(beitrag) {
        if (!beitrag || beitrag.length === 0) {
          return ".redc";
        } else return ".redc";
      }

      getClassByColtype(coltype) {
        if (coltype === "number" || coltype === "numberstring") {
          return "rightalign";
        }
      }

      getIcon(detailsOpened) {
        if (detailsOpened) {
          return 'close';
        } else return 'create';
      }
    }

    window.customElements.define(MyVersicherte.is, MyVersicherte);
  </script>
</dom-module>