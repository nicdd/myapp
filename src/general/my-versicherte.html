<!--
Die Versicherten-Seite
Auf dieser Seite werden nur die Pächter dargestellt die eine Versicherung abgeschlossen haben.
Diese kann beim KVD oder bei einer externen Versicherungsgesellschaft abgeschlossen sein.
Ein bisher Versicherter der nicht mehr bezahlt hat, wird zuerst telefonisch, per E-Mail oder per Brief erinnert.

Wenn für diesen Pächter keine Zahlung und keinen Versicherungsnachweis erfasst wurden, OBWOHL für ihn die Erinnerungsversuche
unternommen wurden, wird dieser:

  - authomatisch vom System nach 14 Tagen nach dem Erinnerungskontakt; 
  - manuell durch den Versicherungsbeauftragten;

in die Liste der "nicht versicherten" verschoben. Die Verschiebung in die Liste der anzumahnenden Pächter setzt
zwingend voraus, dass der Versicherungsbeauftragter die Erinnerungsversuche unternommen und protokolliert hat.

Für die nicht - versicherten Pächter wird eine Benachrichtigungs-EMail an den Verein samt einem 
an der E-Mail angehängten Mahnungs-Anschreiben verschickt. Die E-Mail an den Verein enthält zwingend
die Informationen über die nicht erfolgreichen Versuche, ihn zur Zahlung zu bewegen.
Der 14-Tage Frist kann vom Versicherungsbeauftragten auf maximal 1 Monat verlängert werden.

***********************************************
Entstehung und Änderungen der Versichertenliste
***********************************************
Die Versichertenliste entsteht initial durch das Importieren der Versichertenbestand aus der CSV-Datei vom KVD.
Weiterhin, kann der Benutzer, manuell durch die Bearbeitung der "nicht verischerten" Liste, einzelne "nicht Verischerte"
in die Versichertenliste verschieben. Dabei musste er die Informationen über den letzten gültigen Zahlungseing erfasst haben
(eingezahlten Zahlungsbetrag, Datum, Vericherungsoptionen(FED usw)).

Man kann Einträge aus dieser Liste in die Nicht-Versicherten-Liste verschieben oder ganz Löschen.
Eine Löschung aus der Versichertenliste führt nicht zu einer tatsächlichen Löschung, sondern in die Verschiebung der 
Daten in einer Versicherten-Passivliste, denn es könnte durchaus sein, dass man uach nach einer Kündigung die 
Daten über die Versicherung noch braucht. Die Einträge in der Passivliste werden vom System nach 2 Jahren aus der Liste entfernt.
Ab diesem Zeitpunkt kennt das System keine Informationen mehr über die versicherte Person.


-->

<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-progress-button/paper-progress-button.html">
<!-- <link rel="import" href="../../bower_components/papa-parse/papa-parse.html">
<link rel="import" href="../../bower_components/papa-parse/papa-unparse.html"> -->


<link rel="import" href="../../bower_components/vaadin-grid/theme/material/all-imports.html">
<link rel="import" href="../../bower_components/vaadin-button/vaadin-button.html">
<link rel="import" href="../clients/firstclient.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../utils/grt-grid-pagination.html">


<dom-module id="my-versicherte">
  <template>
    <style include="shared-styles">
      :host {
        /* Stretch this element to fill viewport */
        height: 85vh;

        /* Make a flex column layout of children */
        display: flex;
        flex-direction: column;
      }

      /* iron-pages { */
      /* Stretch this element in the parent flex */
      /* flex: 1;  */

      /* Make a flex column layout of children */
      /* display: flex;
          flex-direction: column;
        } */

      .toolbar {
        height: 32px;
        padding: 10px;
        line-height: 32px;
        background: #eee;
      }

      .page {
        /* Stretch this element in the parent flex */
        flex: 1;

        /* Make a flex column layout of children */
        display: flex;
        flex-direction: column;

        /*
            Let the page contents scroll. Unnecessary for <vaadin-grid>,
            but could be useful for other pages.
          */
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* .content {
          padding: 8px;
        } */

      vaadin-grid {
        /* Stretch this element in the parent flex */
        flex: 1;
      }

      /* :host {
        height: 100%;
        width: 100%;
        overflow: auto;
        display: inline-block;
      } */
      /* :host {
        display: block;

        padding: 10px;
        height: 100% !important;
      } */

      /* #mygrid {
        min-height: calc(100vH - 250px);
      } */

      /* .page-content {

        margin: 16px;
        padding: 16px;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        margin-top: 62px;
        min-height: calc(100% - 62px);
        overflow: auto;
        width: 96%;
      } */

      .demo {
        --paper-progress-active-color: #1875d1;
        --paper-progress-container-icolor: #00000000;

        --paper-button-mixin: {
          padding: 0em 0.5em 0em 0.5em;
          background-color: #1976d2;
          color: white;
        }

        --paper-button-disabled-mixin: {
          background: #efefef;
          color: black;
        }
      }

      .vaadin-demo-input[readonly] {
        border: 2px solid transparent;
        pointer-events: none;
      }

      input[vaadin-demo-input] {
        max-width: 10px !important;
      }

      vaadin-button {
        margin-bottom: 20px;
      }

      .vaadin-demo-input {
        font: inherit;
        width: 100%;
        max-width: 50%;
      }


      /* .header {
          max-height: 5px !important;
        } */
    </style>

    <first-client id="firstclient"></first-client>
    <!-- <papa-parse auto url="http://localhost:8000/loadCSV/gaertner" rows="{{mdata}}"></papa-parse> -->
    <div class="toolbar">
      <vaadin-checkbox checked="{{editing}}" style="margin-bottom: 20px">Enable Editing</vaadin-checkbox>
      <vaadin-button raised id="addbtn">Add Item</vaadin-button>
      <vaadin-button raised id="rmbtn">Remove Item</vaadin-button>
      <paper-progress-button class="demo" bottom raised on-click="postCats" loading-label="Nicht so hecktisch ..."
        loading="[[_loading]]">Speichern</paper-progress-button>
      <grt-grid-pagination id="pages" datalength="[[mdata.length]]" page-size="{{pageSize}}" pstart="{{_pageStart}}"
        on-pagechanged="changePage"></grt-grid-pagination>
    </div>

    <div class="page">
      <vaadin-grid id="mygrid" page-size="{{pageSize}}" active-item="{{activeItem}}" aria-label="Basic Binding Example"
        items="[[mdata]]" column-reordering-allowed>
        <template class="row-details">
          <div class="details">
            <p>
              <span>Bin [[item.alter]] alt</span><br>
              <small>[[item.description]]</small>
            </p>
            <p>
              <span>Hi! My name is [[item.firstName]]!</span><br>
              <small>[[item.email]]</small>
            </p>
          </div>
        </template>
        <!--auto-select wenn man will dass man auch über das anklicken in der zeile nicht nur in der box selektieren kann-->
        <vaadin-grid-selection-column auto-select></vaadin-grid-selection-column>

        <vaadin-grid-column width="40px" flex-grow="0" text-align="end">
          <template class="header">#</template>
          <template>[[index]]</template>
          <!-- If necessary, the footer could be set using <template class="footer"> -->
          <!-- <template class="footer">#</template> -->
        </vaadin-grid-column>
        <!-- <vaadin-grid-column-group resizable> -->
        <vaadin-grid-column path="firstName">
          <template class="header">
            <vaadin-grid-sorter path="firstName" on-sorter-changed="_sortChange">
              First Name
            </vaadin-grid-sorter>

          </template>
          <template>
            <input class="vaadin-demo-input" value="{{item.firstName::input}}" readonly$="[[!editing]]" hidden$="[[!editing]]"
              style="max-width: -moz-available;">
            <label hidden$="[[editing]]">[[item.firstName]]</label>
          </template>
          <!-- <template class="footer">First Name</template> -->
        </vaadin-grid-column>

        <!-- <vaadin-grid-filter-column path="lastName" resizable> -->
        <vaadin-grid-column path="lastName" resizable>
          <template class="header">
              <vaadin-grid-sorter path="lastName" on-sorter-changed="_sortChange">
            Last Name
          </vaadin-grid-sorter>
          </template>
          <template>
            <input class="vaadin-demo-input" value="{{item.lastName::input}}" readonly$="[[!editing]]" hidden$="[[!editing]]"
              style="max-width: -moz-available;">
            <label hidden$="[[editing]]">[[item.lastName]]</label>
          </template>
          <!-- <template class="footer">Last Name</template> -->
          <!-- </vaadin-grid-filter-column> -->
        </vaadin-grid-column>
        <!-- </vaadin-grid-column-group> -->
        <vaadin-grid-column path="alter" header="Alter" flex-grow="0" text-align="end" resizable>
          <template class="header">
            <vaadin-grid-sorter path="alter" on-sorter-changed="_sortChange">
              Alter
            </vaadin-grid-sorter>
          </template>
          <!--
              <template> <input class="vaadin-demo-input" value="{{item.alter::input}}" readonly$="[[!editing]]" style="max-width: -moz-available;"></template>
              <template class="footer">Alter</template> -->
              
        </vaadin-grid-column>
        <!-- <vaadin-grid-column-group> -->
        <vaadin-grid-column width="200px">
          <template class="header">Email</template>
          <template>[[item.firstName]].[[item.lastName]]@example.com</template>
        </vaadin-grid-column>

        <vaadin-grid-column width="8em">
          <template class="header">Address</template>
          <template>
            <div style="white-space: normal">[[item.street]], [[item.city]]</div>
          </template>
          <!-- <template class="footer">Address</template> -->
        </vaadin-grid-column>
        <!-- </vaadin-grid-column-group> -->

        <vaadin-grid-column width="100px">
          <template class="header"></template>
          <template>
            <vaadin-checkbox aria-label$="Show Details for [[firstName]]" checked="{{detailsOpened}}">Details</vaadin-checkbox>
          </template>
        </vaadin-grid-column>
      </vaadin-grid>

    </div>
    <!-- <div id="pages"></div> -->


  </template>





  <script>
    class MyVersicherte extends Polymer.Element {
      static get is() { return 'my-versicherte'; }

      static get properties() {
        return {
          pageSize: {
            type: Number,
            value: null,
            observer: 'changePage'
          },
          _pageStart: {
            type: Number,
            value: 0
            //observer: '_setPageEnd'
          },
          // _pageEnd: {
          //   type: Number,
          //   value: 0
          // },
          _katzen: {
            type: Array,
            value: null,
            notify: true
          },
          _loading: {
            type: Boolean,
            value: false
          },
          mdata: {
            type: Array,
            value: [],
            notify: true,
            reflectToAttribute: true
          },
          _pages: {
            type: Object,
            value: null
          },
          selected: {
                    type: Boolean,
                    value: false,
                    observer: '_activeChanged',
                }
        }
      }

      _sortChange(e) {
        if (e.target && e.target.path && e.target.direction) {
          let key = e.target.path;
          let direction = e.target.direction;
          let records = this.mdata;
          console.log('sortchange called');

          console.log('sortchange called e.target.path' + key + ' e.target.direction' + direction + " nritems" + records.length)
         
          if(!isNaN(this.mdata[0][key])){
             // for numbers
            records.sort(function(a,b){
            
            if( direction === 'asc'){
              if(a[key] < b[key]) return -1;
              if(a[key] > b[key]) return 1;
            } else {
              if(a[key] < b[key]) return 1;
              if(a[key] > b[key]) return -1;
            }
            return 0;
          });

          } else{
            // for strings
            records.sort(function(a,b){
            
            if( direction === 'asc'){
              if(a[key].toLowerCase() < b[key].toLowerCase()) return -1;
              if(a[key].toLowerCase() > b[key].toLowerCase()) return 1;
            } else {
              if(a[key].toLowerCase() < b[key].toLowerCase()) return 1;
              if(a[key].toLowerCase() > b[key].toLowerCase()) return -1;
            }
            return 0;
          });

          }
          
          this.set('mdata', JSON.parse(JSON.stringify(records)));
          this.changePage();
        }

      }

      changePage() {

        console.log('do pagination changed page fff + this._pageSize' + this.pageSize);

        //this.$.mygrid.items = this.mdata.slice(this._pageStart, end);
        if (this._pageStart || this._pageStart === 0) {
          let end = parseInt(this._pageStart) + parseInt(this.pageSize);
          let newItems = this.mdata.slice(this._pageStart, end);
          // console.log('do pagination this._pageStart' + this._pageStart + ' pageSize' + this._pageSize + " newItemslength:" + newItems.length)
          // console.log('mdata.length' + this.mdata.length)


          this.$.mygrid.items = newItems;
        }

      }



      ready() {
        super.ready();
        this.$.firstclient.getCSV().then((resp) => {
          console.log("die antwort kam:" + JSON.stringify(resp))
          this.set('pageSize', 10)
          this.mapToJSON(resp);
          //this.mdata = JSON.stringify(resp.cats)
        })


        this.$.addbtn.addEventListener('click', () => {
          console.log('add gedruckt')
          this.push('mdata', { firstName: "Psuhido", lastName: "Fake", alter: 222, street: "pushtest 22", city: "test" });
        });

        this.$.rmbtn.addEventListener('click', () => {
          console.log('remove gedruckt')
          this.pop('mdata');
        });

        this.$.mygrid.addEventListener('selected-items-changed', (e) => {
          this.doOnSelection(e);
        })
        /**
         *  When a row is clicked or the space key is pressed while a row cell is in focus, the related item object is assigned as the grid's activeItem.
      
      To programmatically select items, the activeItem, for example, could be added to the grid's selectedItems array. The methods selectItem(item) and deselectItem(item) can also be used to select or deselect items.
      
      In the example below, the grid's selectedItems array is replaced whenever activeItem changes, making it single-selectable. 
         * ABER NICHT ZUSAMMEN MIT CHECCKBOX SELECTION sondern nur die akteull selektierte itm zu wissen
         */
        this.$.mygrid.addEventListener('active-item-changed', function (event) {
          const item = event.detail.value;
          //this.$.mygrid.selectedItems = item ? [item] : [];
          console.log('active item' + JSON.stringify(event.target.activeItem))
        });

        // window.document.addEventListener('WebComponentsReady', () => {
        //   let rws = this.shadowRoot.querySelectorAll('[part-="row"]');
        //   this.doStyle(rws);
        //   // rws.forEach((elem) => {
        //   //   console.log('elem wird gestiled')
        //   //   //elem.style['height'] = "10px";

        //   // })

        // })

        // const groups = this.shadowRoot.querySelectorAll('vaadin-grid-column-group');
        // groups[0].headerRenderer = function (root, column, rowData) {
        //   root.textContent = 'GanzerName';
        // };
        // groups[1].headerRenderer = function (root, column, rowData) {
        //   root.textContent = 'Kontaktdaten';
        // };

      }

      doOnSelection(e) {

        console.log('selectiert sind' + JSON.stringify(e.target.selectedItems));


      }


      mapToJSON(resp) {
        let transformedResult = [];
        let columns = resp[0];
        console.log('das sind die columns' + columns.toString())
        for (let i = 1; i < resp.length; i++) {
          let myRowObj = {};
          for (let j = 0; j < resp[i].length; j++) {
            let attrName = columns[j];
            let attrValue = (attrName === "alter") ? (isFinite(resp[i][j]) && !isNaN(resp[i][j]) ? parseInt(resp[i][j]) : 0) : resp[i][j];
            myRowObj[attrName] = attrValue;
            // Object.assign( myRowObj, {
            //   attrName : resp[i][j]
            // });
          }
          transformedResult.push(myRowObj);
          //this.push('mdata', myRowObj)
        }
        // console.log('transformed:' + JSON.stringify(transformedResult))
        this.set('mdata', transformedResult);
        // this.$.mygrid.items = transformedResult;
        //this.doPagination()

      }

      postCats() {
        console.log('data ist' + JSON.stringify(this.$.ggg.data))
        let self = this;
        self._setLoading(true)
        console.log('speichern gedrückt');
        self.$.firstclient.postCats(JSON.stringify({ cats: self._katzen })).finally(() => {
          console.log('finally erreicht')
          setTimeout(function () {
            self._setLoading(false)
          }, 1000);
        })
      }

      _setLoading(val) {
        this.set('_loading', val);
      }

      _activeChanged(newV, oldV){
        console.log('selected changed newV:' + newV + " oldV:" + oldV)
        if (newV){
          this.$.firstclient.getCSV().then((resp) => {
          console.log("die antwort kam:" + JSON.stringify(resp))
          this.set('pageSize', 10)
          this.mapToJSON(resp);
          this.changePage()
          //this.mdata = JSON.stringify(resp.cats)
        })
        }
      }
    }

    window.customElements.define(MyVersicherte.is, MyVersicherte);
  </script>
</dom-module>