<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-progress-button/paper-progress-button.html">
<link rel="import" href="../../bower_components/iron-collapse-button/iron-collapse-button.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../first-domain-styles.html">
<link rel="import" href="../table-styles.html">
<link rel="import" href="../clients/firstclient.html">
<link rel="import" href="../clients/basicclient.html">

<link rel="import" href="../utils/grt-grid-pagination.html">
<link rel="import" href="../utils/export-chooser.html">
<link rel="import" href="../utils/grt-dialog.html">
<link rel="import" href="../utils/apps-dialog.html">
<link rel="import" href="../utils/column-sorter.html">
<link rel="import" href="../utils/grt-sand-clock.html">
<link rel="import" href="../utils/grt-gartler.html">
<link rel="import" href="../utils/grt-gartler-history.html">

<dom-module id="my-paechter">
    <template>
        <style include="first-domain-styles table-styles">
            :host {
                /* Stretch this element to fill viewport */
                height: calc(100vh - 88px);
                flex: 1;

                /* Make a flex column layout of children */
                display: flex;
                flex-direction: column;
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                padding: var(--content-padding);
            }

            .toolbar {
                /* height: 40px; */
                padding: 5px;
                /*line-height: 32px;*/
                background: #eee;
            }

            iron-collapse-button {
                cursor: cursor;
                padding-right: 12px;
            }

            iron-collapse-button div[slot="collapse-trigger"] {
                height: 48px;
                line-height: 48px;
            }

            iron-collapse-button div[slot="collapse-content"] {
                margin-right: -12px;
            }

            paper-button {
                padding: 0.2em 0.5em 0.2em 0.5em !important;
            }

            .button {
                padding: 0px 2px 0px 2px !important;
            }

            .rightalign {
                text-align: right !important;
            }

            .centered-cell {
                text-align: center !important;
                vertical-align: middle !important;
            }
        </style>

        <first-client id="firstclient"></first-client>
        <basic-client id="bclient"></basic-client>
        <grt-dialog id="deletedialog" dialog-type="confirmation" confirmation-name="Löschen" cancel-name="Abbrechen"
            on-grtconfirm="_removeItem"></grt-dialog>
        <grt-dialog id="grtinfodialog" dialog-type="info"></grt-dialog>
        <export-chooser id="exportdialog" dialog-type="info" confirmation-name="Schließen"
            on-export-data="exportPaechter"></export-chooser>
        <apps-dialog id="appsdialog" action-buttons="[[actionButtons]]" tasks="[[getSelected(mvdata.*)]]"></apps-dialog>
        <grt-sand-clock id="sandhour"></grt-sand-clock>
        <div>
            <div class="toolbar layout horizontal justified" flex>
                <template is="dom-if" if="[[spaltenConf.columns.length]]">
                    <grt-grid-pagination id="pagesss" datalength="[[mvdata.length]]" page-size="{{pageSize}}"
                        pstart="{{_pageStart}}" on-pagechanged="changePage" style-domain="first-domain">
                    </grt-grid-pagination>
                </template>
                <div class="layout horizontal justified" flex="50">
                    <button id="appsbutton" on-click="_showApps" disabled="[[_noOneSelected(mvdata.*)]]"
                        class="action-button">
                        <iron-icon icon="apps" id="appsicon" slot="item-icon" on-click="_showApps"></iron-icon>
                    </button>
                    <paper-button disabled="[[isSaveAllDisabled(mvdata.*, openeddetails.*, _isAenderung)]]" bottom
                        raised on-click="postPaechter">Speichern</paper-button>
                    <paper-button disabled="[[isExportDisabled(mvdata.*, openeddetails.*)]]" bottom raised
                        on-click="_showExportDialog">Exportieren</paper-button>
                </div>
            </div>
            <div class="demo">
                <div class="table-responsive-vertical shadow-z-1">
                    <table id="table" class="table table-condensed table-hover">
                        <thead>
                            <th class="centered-cell">
                                <paper-checkbox on-change="_checkAll" checked="[[_areAllSelected(mvdata.*)]]">
                                </paper-checkbox>
                            </th>
                            <template is="dom-repeat" items="[[spaltenConf.columns]]" as="sc1">
                                <template is="dom-if" if="[[sc1.th_show]]">
                                    <th>
                                        <column-sorter id="[[sc1.colname]]" colname="[[sc1.alias]]"
                                            path="[[sc1.colname]]" coltype="[[sc1.coltype]]"
                                            on-sorter-changed="_sortChange">
                                        </column-sorter>
                                    </th>
                                </template>
                            </template>
                            <th class="button"></th>
                            <th class="button"></th>
                        </thead>
                        <tbody>
                            <template is="dom-repeat" items="[[mvpagedata]]" as="paechter">
                                <tr class$="[[paechter.paechter.status]]">
                                    <td class="centered-cell">
                                        <paper-checkbox class="[[getClassByBeitrag(paechter.BEITRAG)]]"
                                            id="[[getGridElementID(index, _pageStart, 'scb')]]" on-change="_checkOne"
                                            checked="[[_isItemSelected(_pageStart, index, mvdata.*)]]"></paper-checkbox>
                                    </td>
                                    <template is="dom-repeat" items="[[spaltenConf.columns]]" as="sc2">
                                        <template is="dom-if" if="[[sc2.th_show]]">
                                            <td>[[_getPaechterData(paechter, sc2.colname)]]</td>
                                        </template>
                                    </template>
                                    <td class="button">
                                        <button id="bto[[paechter.GARTENNUMMER]]" on-click="_openDetails"
                                            class="first-domain-endpagebutton action-button">
                                            <iron-icon id="cro[[paechter.GARTENNUMMER]]"
                                                icon="[[getIcon(paechter._detailsOpened)]]" slot="item-icon"
                                                on-click="_openDetails"></iron-icon>
                                        </button>
                                    </td>
                                    <td class="button">
                                        <button id="btr[[paechter.GARTENNUMMER]]" on-click="_confirmRemove"
                                            class="first-domain-endpagebutton action-button"
                                            disabled="[[paechter._detailsOpened]]">
                                            <iron-icon id="rmi[[paechter.GARTENNUMMER]]-[[index]]" icon="delete"
                                                slot="item-icon" on-click="_confirmRemove"></iron-icon>
                                        </button>
                                    </td>
                                </tr>
                                <template is="dom-if" if="[[paechter._detailsOpened]]">
                                    <tr class="details">
                                        <td colspan="13" class="no-padding">
                                            <iron-collapse-button expand-icon="add-circle-outline"
                                                collapse-icon="remove-circle-outline"
                                                class="detailelement light-element flex" opened>
                                                <div slot="collapse-trigger" class="flex">
                                                    <div class="layout horizontal justified">
                                                        <span>Datenbearbeitung</span>
                                                    </div>
                                                </div>
                                                <div slot="collapse-content" class="corrected-margin">
                                                    <div class="mcard strong-text-color">
                                                        <grt-member id="mmbr[[_pageStart]]-[[index]]"
                                                            id-key="GARTENNUMMER" member="[[paechter]]"
                                                            col-conf="[[spaltenConf]]" on-savemember="_postOnePaechter">
                                                            <h4 slot="title">Pächter</h4>>
                                                        </grt-member>

                                                    </div>
                                                </div>
                                            </iron-collapse-button>
                                        </td>
                                    </tr>
                                    <tr class="details">
                                        <td colspan="13" class="no-padding">
                                            <iron-collapse-button id="history_clps[[_pageStart]]-[[index]]"
                                                expand-icon="add-circle-outline" collapse-icon="remove-circle-outline"
                                                class="detailelement light-element flex">
                                                <div slot="collapse-trigger" class="flex">
                                                    <div class="layout horizontal justified">
                                                        <span>Änderungshistorie</span>
                                                    </div>
                                                </div>
                                                <div slot="collapse-content" class="corrected-margin">
                                                    <div class="mcard strong-text-color">
                                                        <grt-gartler-history id="history[[_pageStart]]-[[index]]"
                                                            ident="[[paechter.GARTENNUMMER]]"
                                                            domain="foerdermitglieder">
                                                            <h4 slot="title">Fördermitglied</h4>
                                                        </grt-gartler-history>

                                                    </div>
                                                </div>
                                            </iron-collapse-button>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>





    <script>
        class MyPaechter extends Polymer.Element {
            static get is() { return 'my-paechter'; }

            static get properties() {
                return {
                    logg: {
                        type: Boolean,
                    },
                    actionButtons: {
                        type: Array,
                        value: ['email', 'rechnung', 'meldung', 'brief']
                    },

                    pageSize: {
                        type: Number,
                        value: null,
                        notify: true,
                        observer: 'changePage'
                    },

                    _pageStart: {
                        type: Number,
                        value: 0
                    },

                    _loading: {
                        type: Boolean,
                        value: false
                    },

                    mvdata: {
                        type: Array,
                        value: [],
                        notify: true,
                        reflectToAttribute: true
                    },

                    mvpagedata: {
                        type: Array,
                        value: [],
                        notify: true,
                        reflectToAttribute: true
                    },

                    _pages: {
                        type: Object,
                        value: null
                    },

                    selected: {
                        type: Boolean,
                        value: false,
                        observer: '_activeChanged',
                    },

                    columnNames: {
                        type: Array,
                        value: []
                    },

                    openeddetails: {
                        type: Array,
                        value: []
                    },

                    _isAenderung: {
                        type: Boolean
                    },

                    spaltenConf: {
                        type: Array,
                        value: null,
                        notify: true,
                        observer: '_spaltenConfReady'
                    },
                }
            }

            _getPaechterData(paechter, cname) {
                switch (cname) {
                    case "ALTER":
                        return this.getAlterBy(paechter.GEBURTSDATUM);
                        break;
                    case "JUBILAEUM":
                        return this.getJubilaeumBy(paechter.GEBURTSDATUM);
                        break;
                    default:
                        return paechter[cname];
                        break;
                }
            }

            _spaltenConfReady() {
                if (this.spaltenConf && this.spaltenConf.columns && this.spaltenConf.columns.length) {
                    this.$.firstclient.getAsJSON('paechter').then((resp) => {
                        if (resp) {
                            this.splitToObjects(resp).finally(() => {
                                //wenn pageSize nur an einer stelle initialisiert wird (in then von splitToObjects)
                                // dann der gleiche wert 10 wird nicht noch mal zu der pagination Componente getriggert
                                // denn er sich noch nicht geändert hatte, die Komp beim ersten mal aber nicht da war
                                this.set('pageSize', parseInt(0));
                                this.changePage();
                            });
                        } else {
                            showToast(this, 'Bei der Initialisierung der Seite wurden keine Pächterdaten gefunden', TOAST_TYPE.ERROR);
                        }
                    }).catch((err) => {
                        console.log("Fehler beim get fuer paechter  kam:" + JSON.stringify(err))
                        showToast(this, 'Die Pächter konnten nicht geladen werden', TOAST_TYPE.ERROR);
                    })
                }
            }

            _confirmRemove(e) {
                e.preventDefault();
                this.$.deletedialog.showDialog(
                    {
                        "title": "Pächterdaten Löschen",
                        "message": "Bitte bestätigen Sie, dass Sie den Datensatz wirklich entfernen möchten.",
                        "origData": e.target.id.substring(3)
                    })
                e.stopPropagation();
            }

            _removeMetadata(paechter) {
                let vToSave = JSON.parse(JSON.stringify(paechter))
                const keysToReset = ["selected", "_detailsOpened"];
                Object.keys(vToSave).forEach((vkey) => {
                    if (keysToReset.some((elem) => elem === vkey)) {
                        delete vToSave[vkey];
                    }
                })
                return vToSave;
            }

            ready() {
                super.ready();

                if (this.$)
                    this.$ = new Proxy(this.$, {
                        get: ($, id) => $[id] || this.shadowRoot.getElementById(id),
                        set: ($, id, element) => {
                            $[id] = element;
                            return true;
                        }
                    });

                this._loadColumnConfigThenData();
            }

            _loadColumnConfigThenData() {
                this.$.bclient.getDomaenenColumnConfig('paechter').then((domConf) => {
                    if (!domConf || !domConf.columns || !Array.isArray(domConf.columns)) {
                        throw 'nicht gefunden';
                    } else {
                        domConf.columns.sort((a, b) => {
                            return (a.th_show && a.postion && !isNaN(a.position) && b.th_show && b.position && !isNaN(b.position) && parseInt(a.position) < parseInt(b.position) ? 1 : -1)
                        })
                        console.warn('conf ist' + JSON.stringify(domConf))
                        this.set('spaltenConf', domConf);
                        showToast(this, 'Die Pächter-Spaltenkonfiguration wurde erfolgreich geladen', TOAST_TYPE.SUCCESS);
                    }

                }).catch((err) => {
                    console.warn('conf column  err' + err)
                    this._defaultColumnConf.columns.sort((a, b) => {
                        return (a.th_show && a.postion && !isNaN(a.position) && b.th_show && b.position && !isNaN(b.position) && parseInt(a.position) < parseInt(b.position) ? 1 : -1)
                    })
                    console.warn('default conf ist' + JSON.stringify(this._defaultColumnConf))
                    this.set('spaltenConf', this._defaultColumnConf);
                    showToast(this, 'Keine Spaltenkonfiguration für die Pächter konnte geladen werden, default wird benutzt', TOAST_TYPE.ERROR);
                })
            }

            _openDetails(e) {
                e.model.set("paechter._detailsOpened", !e.model.paechter._detailsOpened);
                if (e.model.paechter._detailsOpened) {
                    this.push('openeddetails', true);
                } else {
                    this.shift('openeddetails');
                }
                e.stopPropagation();
            }

            _sortChange(e) {
                let self = this;
                if (e.target && e.target.path && e.target.direction) {
                    let otherSorter = this.shadowRoot.querySelectorAll('column-sorter');
                    otherSorter.forEach((os) => {
                        if (os.direction && (os.colname !== e.target.colname)) {
                            os.direction = null;
                        }
                    })
                    let key = e.target.path;
                    let direction = e.target.direction;
                    let coltype = e.target.coltype;
                    let records = JSON.parse(JSON.stringify(self.mvdata));
                    switch (coltype) {
                        case 'numberstring':
                            records = this._alphaNumbersSorter(self, records, direction, key);
                            break;
                        case 'number':
                            if (key === 'ALTER') {
                                records = this._sortByGeburtsdatum(self, records, direction, 'GEBURTSDATUM');
                            } else {
                                records = this._numbersSorter(records, direction, key);
                            }
                            break;
                        case 'string':
                            records = this._stringsSorter(records, direction, key);
                            break;
                        case 'date':
                            if (key === 'JUBILAEUM') {
                                records = this._sortByJubilaeum(self, records, direction);
                            } else if (key === 'GEBURTSDATUM') {
                                records = this._sortByGeburtsdatum(self, records, direction, key);
                            } else {
                                records = this._stringsSorter(records, direction, key);
                            }
                            break;
                        default:
                            records = this._stringsSorter(records, direction, key);
                            break;
                    }
                    self.set('mvdata', records);
                    self.changePage();
                }
            }

            _alphaNumbersSorter(self, records, direction, key) {
                records = records.sort((o1, o2) => {
                    let result = self.naturalSorter((o1[key] || "0"), (o2[key] || "0"));
                    if (direction === 'asc') {
                        return (result < 0) ? -1 : 1;
                    } else {
                        return (result < 0) ? 1 : -1;
                    }
                    return 0;
                });
                return records;
            }

            _numbersSorter(records, direction, key) {
                console.warn('aufgerufen')
                records.sort((a, b) => {
                    if (direction === 'asc') {
                        if ((a[key] || 0) < (b[key] || 0)) return -1;
                        if ((a[key] || 0) > (b[key] || 0)) return 1;
                    } else {
                        if ((a[key] || 0) < (b[key] || 0)) return 1;
                        if ((a[key] || 0) > (b[key] || 0)) return -1;
                    }
                    return 0;
                });
                console.warn('beendet')
                return records;
            }

            _stringsSorter(records, direction, key) {
                records.sort((a, b) => {
                    if (direction === 'asc') {
                        if ((a[key] || "").toLowerCase() < (b[key] || "").toLowerCase()) return -1;
                        if ((a[key] || "").toLowerCase() > (b[key] || "").toLowerCase()) return 1;
                    } else {
                        if ((a[key] || "").toLowerCase() < (b[key] || "").toLowerCase()) return 1;
                        if ((a[key] || "").toLowerCase() > (b[key] || "").toLowerCase()) return -1;
                    }
                    return 0;
                });
                return records;
            }

            _sortByGeburtsdatum(self, records, direction, key) {
                records.sort(function (a, b) {
                    if (direction === 'asc') {
                        if (moment(a[key], 'DD/MM/YYYY').isBefore(moment(b[key], 'DD/MM/YYYY'))) return -1;
                        if (moment(a[key], 'DD/MM/YYYY').isAfter(moment(b[key], 'DD/MM/YYYY'))) return 1;
                    } else {
                        if (moment(a[key], 'DD/MM/YYYY').isBefore(moment(b[key], 'DD/MM/YYYY'))) return 1;
                        if (moment(a[key], 'DD/MM/YYYY').isAfter(moment(b[key], 'DD/MM/YYYY'))) return -1;
                    }
                    return -1;
                });
                return records;
            }

            _sortByJubilaeum(self, records, direction) {
                let gDK = "GEBURTSDATUM";
                records.sort(function (a, b) {
                    if (direction === 'asc') {
                        if (moment((self.getJubilaeumBy(a[gDK]) || 'Dec'), 'MMM').isBefore(moment((self.getJubilaeumBy(b[gDK]) || 'Dec'), 'MMM'))) return -1;
                        if (moment((self.getJubilaeumBy(a[gDK]) || 'Dec'), 'MMM').isAfter(moment((self.getJubilaeumBy(b[gDK]) || 'Dec'), 'MMM'))) return 1;

                    } else {
                        if (moment((self.getJubilaeumBy(a[gDK]) || 'Dec'), 'MMM').isBefore(moment((self.getJubilaeumBy(b[gDK]) || 'Dec'), 'MMM'))) return 1;
                        if (moment((self.getJubilaeumBy(a[gDK]) || 'Dec'), 'MMM').isAfter(moment((self.getJubilaeumBy(b[gDK]) || 'Dec'), 'MMM'))) return -1;

                    }
                    return 1;
                });
                return records;
            }

            changePage() {
                if (this._pageStart || this._pageStart === 0) {
                    let end = parseInt(this._pageStart) + (parseInt(this.pageSize));
                    let newItems = this.mvdata.slice(this._pageStart, end);
                    this.set('mvpagedata', newItems);
                    this.set('openeddetails', [])
                }
            }

            splitToObjects(resp) {
                let paechterData = resp;
                let promises = [];
                return Promise.all(promises).then(() => {
                    this.set('mvdata', paechterData);
                    this.set('pageSize', parseInt(10));
                })
            }

            naturalSorter(as, bs) {
                let a, b, a1, b1, i = 0, n, L,
                    rx = /(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;
                if (as === bs) return 0;
                a = as.toLowerCase().match(rx);
                b = bs.toLowerCase().match(rx);
                L = a.length;
                while (i < L) {
                    if (!b[i]) return 1;
                    a1 = a[i],
                        b1 = b[i++];
                    if (a1 !== b1) {
                        n = a1 - b1;
                        if (!isNaN(n)) {
                            return n;
                        }
                        return a1 > b1 ? 1 : -1;
                    }
                }
                return b[i] ? -1 : 0;
            }

            _setLoading(val) {
                this.set('_loading', val);
            }

            _activeChanged(newV, oldV) {
                console.log('selected changed newV:' + newV + " oldV:" + oldV)
                if (newV) {
                    this.$.firstclient.getAsJSON('paechter').then((resp) => {
                        if (resp) {
                            this.splitToObjects(resp).finally(() => {
                                this.changePage();
                            });
                        } else {
                            showToast(this, 'Bei der erneuten Initialisierung der Seite wurden keine Pächterdaten gefunden', TOAST_TYPE.ERROR);
                        }
                    }).catch((err) => {
                        console.log("Fehler beim get fuer Paecheter  kam:" + JSON.stringify(err))
                        showToast(this, 'Die Pächeterdaten konnten nicht geladen werden', TOAST_TYPE.ERROR);
                    })
                }
            }

            _showExportDialog() {
                if (!this.mvdata || !this.mvdata.length) {
                    this.$.grtinfodialog.showDialog(
                        {
                            "title": "Keine Daten",
                            "message": "Es gibt keine Pächterdaten, die man exportieren könnte."
                        })

                } else {
                    this.$.exportdialog.showDialog(
                        {
                            "title": "Speicherort Auswahl",
                            "message": "Bitte wählen Sie ob eine lokale Speicherung erwünscht ist oder eine Speicherung auf dem Server."
                        })
                }
            }

            exportPaechter(e) {
                let dataAndColumns = { data: this.mvdata, columns: this.spaltenConf.columns }
                this.$.firstclient.exportPaechterAsCSV(dataAndColumns, e.detail).then((savePath) => {
                    if (savePath && savePath.path) {
                        this.$.grtinfodialog.showDialog(
                            {
                                "title": "Daten als CSV - exportieren",
                                "message": "Die Daten der Pächter wurden erfolgreich unter " + savePath.path + " gespeichert."
                            })
                    } else if (savePath) {
                        showToast(this, "Die Daten der Pächter werden unter " + savePath + " gespeichert.", TOAST_TYPE.WARN, 'topRight');
                    }
                }).catch((err) => {
                    showToast(this, 'Der Datenexport der Pächter ist fehlgeschlagen', TOAST_TYPE.ERROR);
                });
            }

            //paechterdata save
            _saveItemData(e) {
                if (e && e.target && e.target.id && !e.target.disabled) {
                    let idxOrigTable = idxActiveTable + (parseInt(this._pageStart) || 0);
                    // das ist och nicht funktionall, siehe versicherte
                    this.set('dosave', idxOrigTable);
                }
                e.stopPropagation();
            }

            _insertChangedPaechter(e) {
                this.splice('mvdata', e.detail.index, 1, e.detail.data)
                this.changePage();
            }

            _insertNewPaechter(e) {
                let self = this;
                self.splice('mvdata', self._pageStart, 0, e.detail);
            }

            _postOnePaechter(e) {
                let toSave = null;
                if (e.type && e.type === 'savemember') {
                    toSave = e.detail.data;
                    let mid = e.target.id;
                    toSave = this._removeMetadata(toSave);
                    this.$.firstclient.postAsJSON(toSave, 'paechter', toSave.GARTENNUMMER).then(() => {
                        this.$[mid].pushSuccesfullEvent(e.type);
                        this._insertChangedPaechter(e);
                        if (this.logg) {
                            let historyID = "history" + mid.substring(4);
                            this.$[historyID].postLogData(toSave, e.detail.logdata);
                        }
                        showToast(this, 'Die Änderungen des Pächters wurden erfolgreich gespeichert', TOAST_TYPE.SUCCESS);
                    }).catch((error) => {
                        showToast(this, 'Fehler bei der Speicherung der Änderungen', TOAST_TYPE.ERROR);
                    })
                }
            }

            postPaechter() {
                if (!this.mvdata || !this.mvdata.length) {
                    this.$.grtinfodialog.showDialog(
                        {
                            "title": "Keine Daten",
                            "message": "Es gibt keine Pächterdaten, die man speichern könnte."
                        })

                } else {
                    let dataAndColumns = { data: this.mvdata, columns: this.columnNames }
                    this.$.sandhour.showDialog();
                    this.$.firstclient.postAsJSON(dataAndColumns, 'paechter').then(() => {
                        console.log('paechter gespeichert')
                        showToast(this, 'Die Paechter wurden erfolgreich gespeichert', TOAST_TYPE.SUCCESS);
                    }).catch(() => {
                        showToast(this, 'Fehler beim Speichern der Paecheterndaten', TOAST_TYPE.ERROR);
                    }).finally(() => {
                        this.$.sandhour._closeDialog();
                    })

                }
            }

            // check-box and apps
            _isItemSelected(_pageStart, index) {
                let path = 'mvdata.' + (_pageStart + index) + '.selected';
                return this.get(path);
            }

            _noOneSelected() {
                return !this.mvdata.some((data) => data.selected);
            }

            _areAllSelected() {
                return !this.mvdata.some((data) => !data.selected);
            }

            _checkAll(e) {
                if (e.currentTarget.checked) {
                    this.mvdata.forEach((mv, idx) => {
                        let path = 'mvdata.' + idx + '.selected'
                        this.set(path, true)
                    })
                } else {
                    this.mvdata.forEach((mv, idx) => {
                        let path = 'mvdata.' + idx + '.selected'
                        this.set(path, false)
                    })
                }
            }

            getSelected() {
                let thetasks = this.mvdata.filter((el) => el.selected === true);
                return thetasks;
            }

            _checkOne(e) {
                let realIndex = e.target.id.substring(3);
                if (e.currentTarget.checked) {
                    let path = 'mvdata.' + realIndex + '.selected'
                    this.set(path, true)
                } else {
                    let path = 'mvdata.' + realIndex + '.selected'
                    this.set(path, false)
                }
            }

            _showApps(e) {
                this.$.appsdialog.showDialog()
                // iziToast.show({
                //   position: "center",
                //   title: 'Hey',
                //   message: 'What would you like to add?',
                // })
            }

            getGridElementID(index, _pageStart, prefix) {
                let realIndex = (parseInt(index) + parseInt(_pageStart));
                return prefix + realIndex;
            }

            //css and dynamic elements
            isSaveAllDisabled() {
                if (!this._isAenderung || (this.openeddetails && this.openeddetails.length) || !this.mvdata || !this.mvdata.length) {
                    return true;
                } else
                    return false;
            }

            isExportDisabled() {
                if ((this.openeddetails && this.openeddetails.length) || !this.mvdata || !this.mvdata.length) {
                    return true;
                } else return false;
            }

            getClassByBeitrag(beitrag) {
                if (!beitrag || beitrag.length === 0) {
                    return ".redc";
                } else return ".redc";
            }

            getIcon(detailsOpened) {
                if (detailsOpened) {
                    return 'close';
                } else return 'create';
            }

            _removeItem(confirmEvent) {
                let id = confirmEvent.detail.substring(0, confirmEvent.detail.indexOf('-'));
                let elem = this.mvdata.find((v) => {
                    return v.GARTENNUMMER === id;
                });
                let idx = this.mvdata.indexOf(elem);
                if (idx >= 0) {
                    this.$.firstclient.deleteOne('paechter', elem.GARTENNUMMER).then(() => {
                        this.splice('mvdata', idx, 1);
                        showToast(this, 'Der Pächter wurde erfolgreich gelöscht', TOAST_TYPE.SUCCESS);
                    }).catch(() => {
                        showToast(this, 'Fehler bei der Löschung des Pächters. Versuchen Sie später noch einmal.', TOAST_TYPE.ERROR);
                    })
                } else if (!elem && idx === -1) {
                    // ist ein fehlerhafter Datensatz ohne Gartennummer, womöglich aus einer leeren Zeile der Importdatei
                    const rowIdx = id.substring(1); // ab dem minus-Zeichen, befindet sich die Zeilenindex
                    this.$.firstclient.deleteOne('paechter', null).then(() => {
                        this.splice('mvdata', rowIdx, 1);
                        showToast(this, 'Der Pächter wurde erfolgreich gelöscht', TOAST_TYPE.SUCCESS);
                    }).catch(() => {
                        showToast(this, 'Fehler bei der Löschung des Pächters. Versuchen Sie später noch einmal.', TOAST_TYPE.ERROR);
                    })
                }
            }

            addPaecheter() {
                // this.$.adddialog.showDialog();
            }

            getAlterBy(geburtsdatum) {
                let years = null;
                if (geburtsdatum) {
                    let gdatMoment = moment(geburtsdatum, 'DD/MM/YYYY');
                    years = moment().diff(gdatMoment, 'years');
                }
                return years;
            }

            getJubilaeumBy(geburtsdatum) {
                let years = null;
                let jmonat = null;
                if (geburtsdatum) {
                    let gdatMoment = moment(geburtsdatum, 'DD/MM/YYYY');
                    years = moment().diff(gdatMoment, 'years');
                    if (!(years % 10) || (years > 50 && !(years % 5))) {
                        console.log('years % 10' + (years % 10) + ' years' + years)
                        console.log('(years % 5)' + (years % 5) + ' years' + years)
                        jmonat = gdatMoment.format('MMM')
                    }
                }
                return jmonat;
            }
        }

        window.customElements.define(MyPaechter.is, MyPaechter);
    </script>
</dom-module>