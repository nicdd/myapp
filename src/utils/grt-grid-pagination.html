<!--
Pagination Element for Vaadin-Grid Tables
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<dom-module id="grt-grid-pagination">
    <template>
        <style include="shared-styles">
            :host {
                display: inline-block;

                padding: 10px;
            }

            #pagination {
                display: block;
                flex-wrap: wrap;
                margin: 20px;
            }

           
        </style>
        <div class="layout horizontal center-justified">


            <div class="layout horizontal center-justified">
                <div style="padding: 0rem 0.3rem;" class="layout horizontal center-justified">
                    <div style="padding: 0rem 0.1rem;">
                        <button id="first" class="endpagebutton" on-click="firstPage">
                            <<</button> <button id="previous" class="pagebutton" on-click="previousPage">
                                <</button> </div>
                     <div style="padding: 0rem 0.1rem;">
                        <label style="color:#999; font-size:14px;">Seite:</label>
                        <select id="sp" value="{{selPage::change}}">

                            <template is="dom-repeat" items="[[_pages]]">
                                <option value="[[item]]">[[item]] von [[_pages.length]]</option>
                            </template>
                        </select>
                    </div>
                    <div style="padding: 0rem 0.1rem;">
                        <button id="next" class="pagebutton" on-click="nextPage">></button>
                        <button id="last" class="endpagebutton" on-click="lastPage">>></button>
                    </div>
                </div>
                <div style="padding: 0rem 0.3rem;">
                    <label style="color:#999; font-size:14px;">Zeilen pro Seite:</label>
                    <select id="si" value="{{pageSize::input}}">
                        <template is="dom-repeat" items="[[rowsperPage]]">
                            <option value="[[item.val]]">[[item.key]]</option>
                        </template>
                    </select>
                </div>
                [[datalength]]
            </div>
        </div>

    </template>

    <script>
        class GrtGridPagination extends Polymer.Element {
            static get is() { return 'grt-grid-pagination'; }

            static get properties() {
                return {
                    selPage: {
                        type: Number,
                        value: 1,
                        observer: 'pageChangedViaBox',
                        notify: true

                    },

                    rowsperPage: {
                        type: Array,
                        value: [{ key: "5", val: 5 }, { key: "10", val: 10 }, { key: "15", val: 15 }, { key: "20", val: 20 }],
                        notify: true
                    },

                    datalength: {
                        type: Number,
                        value: 0,
                        observer: 'doOnDataLengthChanged'
                        //notify: true
                    },
                    _pages: {
                        type: Array,
                        value: [],
                        notify: true
                    },
                    pageSize: {
                        type: Number,
                        value: 5,
                        observer: 'doPageSizeChanged',
                        notify: true
                    },

                    pstart: {
                        type: Number,
                        value: 0,
                        notify: true
                    },

                    pend: {
                        type: Number,
                        value: 0,
                        notify: true
                    }
                }
            }

            ready() {
                super.ready();
            }

            static get observers() {
                return [
                    '_isButtonDisabled(pstart)'
                ]

            }

            _isButtonDisabled() {

                let fp = this.shadowRoot.querySelector('#first');
                let pp = this.shadowRoot.querySelector('#previous');
                let np = this.shadowRoot.querySelector('#next');
                let lp = this.shadowRoot.querySelector('#last');
                if (this.selPage && (parseInt(this.selPage) <= 1)) {
                    fp.setAttribute('disabled', true);
                    pp.setAttribute('disabled', true);
                    np.removeAttribute('disabled');
                    lp.removeAttribute('disabled');

                } else if (this.selPage && (parseInt(this.selPage) >= this._pages.length)) {
                    fp.removeAttribute('disabled');
                    pp.removeAttribute('disabled');
                    np.setAttribute('disabled', true);
                    lp.setAttribute('disabled', true);
                } else {
                    fp.removeAttribute('disabled');
                    pp.removeAttribute('disabled');
                    np.removeAttribute('disabled');
                    lp.removeAttribute('disabled');

                }


            }

            firstPage() {
                if (this.selPage && parseInt(this.selPage) > 1) {
                    this.set('selPage', 1);
                }
            }

            lastPage() {
                if (this.selPage && parseInt(this.selPage) < this._pages.length) {
                    this.set('selPage', this._pages.length);
                }
            }

            previousPage() {
                if (this.selPage && parseInt(this.selPage) > 1) {
                    let previous = parseInt(this.selPage) - 1;
                    this.set('selPage', previous);
                }
            }

            nextPage() {
                if (this.selPage && parseInt(this.selPage) < this._pages.length) {
                    let next = parseInt(this.selPage) + 1;
                    this.set('selPage', next);
                }
            }

            doPageSizeChanged(newV, oldV) {

                let newValue = (newV) ? parseInt(newV) : 0;
                let oldValue = (oldV) ? parseInt(oldV) : 0;
                let anzahlSeiten = Math.ceil(this.datalength / parseInt(this.pageSize));
                if (newValue && oldValue) {
                    // nur für gültige Seitengrößen behandeln
                    if ((newValue !== oldValue)) {
                        let sel = Math.floor((this.pstart) / parseInt(this.pageSize));
                        this.doPagination(sel + 1);
                    }
                }
            }

            doPagination(pageToSelect) {
                let self = this;
                if (this.datalength > 0) {
                    let selectedPage = (pageToSelect && !isNaN(pageToSelect)) ? pageToSelect : 1;
                    let ps = parseInt(self.pageSize);
                    let ln = Math.ceil(self.datalength / ps);
                    let newpags = [];
                    for (let i = 0; i < ln; i++) {
                        newpags[i] = i + 1;
                    }
                    self.set('_pages', JSON.parse(JSON.stringify(newpags)));
                    self.updateItemsFromPage(parseInt(selectedPage));
                }
            }

            doOnDataLengthChanged(newV, oldV) {
                if (newV && newV !== oldV && this.pageSize) {
                    this.doPagination(this.selPage);
                }
            }

            pageChangedViaBox(newV, oldV) {
                if (this.selPage && this.pageSize) {
                    this.set('pstart', (this.selPage - 1) * parseInt(this.pageSize));
                    this.set('pend', this.selPage * parseInt(this.pageSize));
                    this.dispatchEvent(new CustomEvent('pagechanged'));
                }
            }

            updateItemsFromPage(page) {
                if (!page) {
                    return;
                }
                let self = this;
                let ps = parseInt(self.pageSize);

                if (self._pages.length === (page + 1)) {
                    page++;
                    self.set('selPage', page);
                    window.setTimeout(function () {
                        self.$.sp['selectedIndex'] = page - 1;

                    }, 150);

                } else if (page > self._pages.length) {
                    page--;
                    self.set('selPage', page);
                    this.$.sp['selectedIndex'] = (page - 1);

                } else {
                    self.set('selPage', page);
                    window.setTimeout(function () {
                        self.$.sp['selectedIndex'] = page - 1;

                    }, 150);
                }

                this.set('pstart', (page - 1) * ps);
                this.set('pend', page * ps);
                this.dispatchEvent(new CustomEvent('pagechanged'));
            }


        }

        window.customElements.define(GrtGridPagination.is, GrtGridPagination);
    </script>
</dom-module>