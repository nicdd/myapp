<!--
Pagination Element for Vaadin-Grid Tables
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<dom-module id="grt-grid-pagination">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            #pagination {
                display: flex;
                flex-wrap: wrap;
                margin: 5px;
            }

            #pages>button {
                user-select: none;
                /* padding: 5px;
                margin: 0 5px; */
                border-radius: 10%;
                border: 0;
                background: transparent;
                font: inherit;
                outline: none;
                cursor: pointer;
            }

            #pages>button:not([disabled]):hover,
            #pages>button:focus {
                color: #ccc;
                background-color: #eee;
            }

            #pages>button[selected] {
                font-weight: bold;
                color: white;
                background-color: #ccc;
            }

            #pages>button[disabled] {
                opacity: 0.5;
                cursor: default;
            }
        </style>
        <div class="layout horizontal center-justified">
            <div id="pagination">
                <!-- <div id="pages"></div> -->
            </div>

            <div>
                <label>Seite:</label>
                <select id="sp" value="{{selPage::change}}">
                    <template is="dom-repeat" items="[[_pages]]">
                        <option value="[[getPageNumber(index, _pages)]]">[[getPageNumber(index, _pages)]]</option>
                    </template>
                </select>
                <label>von [[_pages.length]]</label>

                <label>Zeilen pro Seite:</label>
                <select id="si" value="{{pageSize::input}}">
                    <template is="dom-repeat" items="[[rowsperPage]]">
                        <option value="[[item.val]]">[[item.key]]</option>
                    </template>
                </select>
                [[selPage]] pstart:[[pstart]]
            </div>
        </div>

    </template>

    <script>
        class GrtGridPagination extends Polymer.Element {
            static get is() { return 'grt-grid-pagination'; }

            static get properties() {
                return {
                    selPage: {
                        type: Number,
                        value: 1,
                        observer: 'pageChangedViaBox',
                        notify: true

                    },

                    rowsperPage: {
                        type: Array,
                        value: [{ key: "5", val: 5 }, { key: "10", val: 10 }, { key: "15", val: 15 }, { key: "20", val: 20 }],
                        notify: true
                    },

                    datalength: {
                        type: Number,
                        value: 0,
                        observer: 'doOnDataLengthChanged'
                        //notify: true
                    },
                    _pages: {
                        type: Object,
                        value: null,
                        notify: true
                    },
                    pageSize: {
                        type: Number,
                        value: 5,
                        observer: 'doPageSizeChanged',
                        notify: true
                    },

                    pstart: {
                        type: Number,
                        value: 0,
                        notify: true
                    },

                    pend: {
                        type: Number,
                        value: 0,
                        notify: true
                    }
                }
            }

            ready() {
                super.ready();

            }

            getPageNumber(idx) {
                console.log('getpAGENUMBER FOR IDX selected element + ' + idx)
                return this.get('_pages.' + idx);
            }

            doPageSizeChanged(newV, oldV) {
                // change 'selected' page button
                let newValue = (newV) ? parseInt(newV) : 0;
                let oldValue = (oldV) ? parseInt(oldV) : 0;
                let anzahlSeiten = Math.ceil(this.datalength / parseInt(this.pageSize));
                if (newValue && oldValue) {
                    // nur für gültige Seitengrößen behandeln
                    if ((newValue !== oldValue)) {
                        //this.setNumberOfPages(anzahlSeiten, this._pages.length);
                        let sel = Math.floor((this.pstart) / parseInt(this.pageSize));
                        //this.set('selPage', sel + 1);

                        this.doPagination(sel + 1);
                        // this.set('selPage', sel + 1);
                    }
                }
            }

            doPagination(pageToSelect) {
                //console.log('dopagination datalength arg1' + arg1 + 'arg2' + arg2)
                if (this.datalength > 0) {
                    console.log('dopagination datalength ' + this.datalength)
                    let selectedPage = (pageToSelect && !isNaN(pageToSelect)) ? pageToSelect : 1;
                    // if (this.selPage && !isNaN(this.selPage)) {
                    //     console.log('nein selected element + ' + this.selPage)
                    this.updateItemsFromPage(parseInt(selectedPage));
                    // } 
                } else {
                    console.log('dopagination datalength <= 0 ')
                }
            }

            doOnDataLengthChanged() {
                this.doPagination(this.selPage);
            }




            setNumberOfPages(newAnzahlSeiten, oldAnzahlSeiten) {
                let self = this;
                self._pages = Array.apply(self._pages, { length: newAnzahlSeiten }).map(function (item, index) {
                    return index + 1;
                });
            }

            pageChangedViaBox() {
                //if (this.selPage)
               this.updateItemsFromPage(parseInt(this.selPage));
               //self.$.sp['selectedIndex'] = this.selPage;
            }

            updateItemsFromPage(page) {
                if (typeof this.datalength === 'string') {
                    console.log('AAACHTUUUUUNG')
                }


                let self = this;
                let ps = parseInt(self.pageSize);
                if (page === undefined) {
                    return;
                }
                if (!self._pages) {
                    console.log('if is 1')
                    self._pages = Array.apply(null, { length: Math.ceil(self.datalength / ps) }).map(function (item, index) {
                        return index + 1;
                    });
                } else if (Math.ceil(self.datalength / ps) > self._pages.length) {
                    console.log('if is 2')
                    let newpags = Array.apply(self._pages, { length: Math.ceil(self.datalength / ps) }).map(function (item, index) {
                        return index + 1;
                    });
                    self.set('_pages', newpags);
                    if (self._pages.length === (page + 1)) {
                        console.log('if is 3')
                        page++;
                        window.setTimeout(function () {
                            self.$.sp['selectedIndex'] = page - 1;

                        }, 100);
                        self.set('selPage', page);
                    } else {
                        this.set('selPage', page);
                    }
                } else if (Math.ceil(self.datalength / ps) < self._pages.length) {
                    console.log('if is 4')
                    self._pages = Array.apply(self._pages, { length: Math.ceil(self.datalength / ps) }).map(function (item, index) {
                        return index + 1;
                    });
                    if (page > self._pages.length) {
                        console.log('if is 5')
                        page--;
                        this.$.sp['selectedIndex'] = (page - 1);
                        self.set('selPage', page);
                    } else {
                        this.set('selPage', page);
                    }
                } else {
                    console.log('if is 6')
                    this.set('selPage', page);
                }


                this.set('pstart', (page - 1) * ps);
                this.set('pend', page * ps);
                this.dispatchEvent(new CustomEvent('pagechanged'));
            }


        }

        window.customElements.define(GrtGridPagination.is, GrtGridPagination);
    </script>
</dom-module>