<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="../../bower_components/file-saver/dist/FileSaver.min.js"></script>

<dom-module id="first-client">
    <template></template>

    <script>
        class FirstClient extends Polymer.Element {
            static get is() { return 'first-client'; }

            static get properties() {
                return {
                    actualLocation: {
                        type: Object,
                        value: {
                            protocol: null,
                            hostname: null
                        }

                    },
                    URLS: {
                        type: Object,
                        value: {

                            CSV_BASIC: {
                                path: '/loadCSV/test',
                                port: '8000'
                            },

                            CSV_PAECHTER: {
                                path: '/loadCSV/paechter',
                                port: '8000'
                            },

                            JSON_PAECHTER: {
                                path: '/api/paechter',
                                port: '8000'
                            },

                            CSV_VERSICHERTE: {
                                path: '/loadCSV/versicherte',
                                port: '8000'
                            },

                            JSON_VERSICHERTE: {
                                path: '/api/versicherte',
                                port: '8000'
                            },

                            JSON_ONE_VERSICHERTER: {
                                path: '/api/versicherter',
                                port: '8000'
                            },

                            JSON_UNKLARE_VERSICHERTE: {
                                path: '/api/unklareversicherte',
                                port: '8000'
                            }
                        }
                    }
                }
            }


            ready() {
                super.ready();
                this._setActualLocation();
            }

            _setActualLocation() {
                this.set('actualLocation', { protocol: window.location.protocol, hostname: window.location.hostname });
            }

            _getSourceURL(uriData, resPath, port) {
                let urlToSource = uriData.protocol + "//" + uriData.hostname + ":" + port + resPath;
                return urlToSource;
            }

            getCSV() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_BASIC.path, this.URLS.CSV_BASIC.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCSVs aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return [['firstName', 'lastName', 'street', 'city'], [, , ,]]
                    } else return response.json();
                }).catch(() => {
                    console.log('getCSV die Anfrage an /loadCSV/test war nicht erfolgreich')
                });
            }



            getVersicherteCSV() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_VERSICHERTE.path, this.URLS.CSV_VERSICHERTE.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCSVs aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return undefined;
                    } else return response.json();
                }).catch((err) => {
                    console.log('getPaechterCSV die Anfrage an /loadCSV/paechter war nicht erfolgreich')
                    return Promise.reject(err);
                });
            }

            getPaechterCSV() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_PAECHTER.path, this.URLS.CSV_PAECHTER.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCSVs aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return undefined;
                    } else return response.json();
                }).catch((err) => {
                    console.log('getPaechterCSV die Anfrage an /loadCSV/paechter war nicht erfolgreich')
                    return Promise.reject(err);
                });
            }

            postVersicherteAsJSON(versicherte) {
                console.log('topost' + JSON.stringify(versicherte))
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_VERSICHERTE.path, this.URLS.JSON_VERSICHERTE.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(versicherte);

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("postVersicherteAsJSON antwort" + JSON.stringify(response));
                    if (response && response.ok) {
                        return response.json();
                    } else return undefined;


                }).catch(() => {
                    console.log('postVersicherteAsJSON die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });
            }

            getUnklareVersicherteAsJSON() {
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_UNKLARE_VERSICHERTE.path, this.URLS.JSON_UNKLARE_VERSICHERTE.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("getUnklareVersicherte as JSON status 204")
                        return undefined;
                    } else {
                        return response.json();
                    }
                }).then((data) => {
                    console.log('firstclient unklare versicherte as json wird gesetzt auf' + JSON.stringify(data))
                    return Promise.resolve(data);
                }).catch((err) => {
                    console.log('getUnklareVersicherteAsJSON die Anfrage war nicht erfolgreich' + JSON.stringify(error))
                });
            }

            postUnklareVersicherteAsJSON(unklareFaelle){
                
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_UNKLARE_VERSICHERTE.path, this.URLS.JSON_UNKLARE_VERSICHERTE.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(unklareFaelle);

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("postUnklareVersicherteAsJSON antwort" + JSON.stringify(response));
                    if (response && response.ok) {
                        return response.json();
                    } else return undefined;


                }).catch(() => {
                    console.log('postUnklareVersicherteAsJSON die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });

            }

            getOnePachter(ganr){
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_PAECHTER.path + "/" + ganr, this.URLS.JSON_PAECHTER.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("getOnePaechter as JSON status 204")
                        return undefined;
                    } else {
                        return response.json();
                    }
                }).then((data) => {
                    console.log('firstclient onepaechter wird gesetzt auf' + JSON.stringify(data))
                    return Promise.resolve(data);
                }).catch((err) => {
                    console.log('getOnePaechter die Anfrage an api/paechter war nicht erfolgreich' + JSON.stringify(error))
                });

            }

            postOnePaechter(theOne){
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_PAECHTER.path + "/" + theOne.GARTENNUMMER, this.URLS.JSON_PAECHTER.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(theOne);

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("postOnePaechter antwort" + JSON.stringify(response));
                    if (!response.ok) { 
                        throw response; 
                    } else if (response && response.ok) {
                        return response.json();
                    } else return undefined;
                }).catch(() => {
                    console.log('postOnePaechter die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                    return Promise.reject();
                });
            }
            
            postOneVersicherter(theOne){
                
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_ONE_VERSICHERTER.path, this.URLS.JSON_ONE_VERSICHERTER.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(theOne);

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("postOneVersicherter antwort" + JSON.stringify(response));
                    if (!response.ok) { 
                        throw response; 
                    } else if (response && response.ok) {
                        return response.json();
                    } else return undefined;


                }).catch(() => {
                    console.log('postOneVersicherter die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                    return Promise.reject();
                });

            }

            deleteUngeklaerterVersicherter(gartennummer){
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_UNKLARE_VERSICHERTE.path, this.URLS.JSON_UNKLARE_VERSICHERTE.port);
                let myHeaders = new Headers();
                
                let myInit = {
                    method: 'DELETE',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL + '/' + gartennummer, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("deleteUngeklaerterVersicherter as JSON status 204")
                        return undefined;
                    } else {
                        return response.json();
                    }
                }).then((data) => {
                    console.log('firstclient deleteUngeklaerterVersicherter wird gesetzt auf' + JSON.stringify(data))
                    return Promise.resolve(data);
                }).catch((err) => {
                    console.log('deleteUngeklaerterVersicherter die Anfrage an api/paechter war nicht erfolgreich' + JSON.stringify(error))
                });

            }

            deleteOneVersicherter(gartennummer){
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_VERSICHERTE.path, this.URLS.JSON_VERSICHERTE.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'DELETE',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL + '/' + gartennummer, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("deleteVersicherter as JSON status 204")
                        return undefined;
                    } else {
                        return response.json();
                    }
                }).then((data) => {
                    console.log('firstclient delete versicherter as json wird gesetzt auf' + JSON.stringify(data))
                    return Promise.resolve(data);
                }).catch((err) => {
                    console.log('getVersicherteAsJSON die Anfrage an api/paechter war nicht erfolgreich' + JSON.stringify(error))
                });

            }

            postPaechterAsJSON(paechter) {
                console.log('topost' + JSON.stringify(paechter))
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_PAECHTER.path, this.URLS.JSON_PAECHTER.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(paechter);

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("postVersicherteAsJSON antwort" + JSON.stringify(response));
                    if (response && response.ok) {
                        return response.json();
                    } else return undefined;


                }).catch(() => {
                    console.log('postVersicherteAsJSON die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });

            }

            updatePaechterAsJSON(paechter){
                console.log('toupdate' + JSON.stringify(paechter))
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_PAECHTER.path, this.URLS.JSON_PAECHTER.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(paechter);

                let myInit = {
                    method: 'PUT',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("updatePaechterAsJSON antwort" + JSON.stringify(response));
                    if (response && response.ok) {
                        return response.json();
                    } else return undefined;


                }).catch(() => {
                    console.log('updatePaechterAsJSON die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });

            }

            getVersicherteAsJSON() {
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_VERSICHERTE.path, this.URLS.JSON_VERSICHERTE.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("getVersicherte as JSON status 204")
                        return undefined;
                    } else {
                        return response.json();
                    }
                }).then((data) => {
                    console.log('firstclient paechter as json wird gesetzt auf' + JSON.stringify(data))
                    return Promise.resolve(data);
                }).catch((err) => {
                    console.log('getVersicherteAsJSON die Anfrage an api/paechter war nicht erfolgreich' + JSON.stringify(error))
                });
            }

            getPaechterAsJSON() {
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_PAECHTER.path, this.URLS.JSON_PAECHTER.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("getPaechter as JSON status 204")
                        return undefined;
                    } else {
                        return response.json();
                    }
                }).then((data) => {
                    console.log('firstclient paechter as jason wird gesetzt auf' + JSON.stringify(data))
                    return Promise.resolve(data);
                }).catch((err) => {
                    console.log('getPaechterAsJSON die Anfrage an api/paechter war nicht erfolgreich' + JSON.stringify(error))
                });
            }

            exportVersicherteAsCSV(versicherte, destination) {
                let asCSV = this.mapToCSV(versicherte);
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_VERSICHERTE.path, this.URLS.CSV_VERSICHERTE.port);
                console.log('topost' + JSON.stringify(versicherte))
                if (destination === "server") {
                    return this._exportRemote(asCSV, sourceURL);
                } else if (destination === "lokal") {
                    return this._saveLokalAsCSV(asCSV, "versicherte_");
                } else {
                    return this._exportRemote(asCSV, sourceURL);
                }
            }

            exportPaechterAsCSV(paechter, destination) {
                let asCSV = this.mapToCSV(paechter);
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_PAECHTER.path, this.URLS.CSV_PAECHTER.port);
                console.log('topost' + JSON.stringify(paechter))
                if (destination === "server") {
                    return this._exportRemote(asCSV, sourceURL);
                } else if (destination === "lokal") {
                    return this._saveLokalAsCSV(asCSV, "paechter_");
                } else {
                    return this._exportRemote(asCSV, sourceURL);
                }
            }

            _exportRemote(asCSV, sourceURL) {

                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "text/plain");

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: asCSV
                };

                let myRequest = new Request(sourceURL, myInit);
                return fetch(myRequest).then((response) => {
                    console.log("post " + sourceURL + " antwort" + response);
                    if (response && response.ok) {
                        //debugger;
                        console.log("post " + sourceURL + " antwort1");
                        return response.json();
                    } else { console.log("post " + sourceURL + " antwort2"); return undefined; }


                }).catch(() => {
                    console.log('postAscsv die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });
            }

            _saveLokalAsCSV(asCSV, saveWas) {
                let nowMoment = moment().format('YYYYMMDD_HHmm')
                let blob = new Blob([asCSV], { type: "text/csv;charset=utf-8" });
                saveAs(blob, saveWas + nowMoment + ".csv")
                
                return Promise.resolve("dem voreingestellten Download-Verzeichnis Ihres Browsers")

            }

            mapToCSV(data) {
                let myForCSVArray = [];
                myForCSVArray.push(data.columns);
                data.data.forEach((d) => {
                    let myDataArray = [];
                    for (var key in d) {
                        if (d.hasOwnProperty(key)) {
                            myDataArray.push(String(d[key]));

                        }
                    }
                    myForCSVArray.push(myDataArray);
                })

                let paL = myForCSVArray;
                let toSave = '';
                paL.forEach((rowArr, idx) => {
                    if (idx !== 0) {
                        toSave += '\n';
                    }
                    let strRow = rowArr.join(',');
                    toSave += strRow;

                })
                return toSave;
            }

        }

        window.customElements.define(FirstClient.is, FirstClient);
    </script>
</dom-module>