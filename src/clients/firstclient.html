<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script src="../../bower_components/file-saver/dist/FileSaver.min.js"></script>

<dom-module id="first-client">
    <template></template>

    <script>
        class FirstClient extends Polymer.Element {
            static get is() { return 'first-client'; }

            static get properties() {
                return {
                    actualLocation: {
                        type: Object,
                        value: {
                            protocol: null,
                            hostname: null
                        }

                    },
                    URLS: {
                        type: Object,
                        value: {
                            CATS_BASIC: {
                                path: '/api/cats',
                                port: '8000'
                            },
                            CSV_BASIC: {
                                path: '/loadCSV/test',
                                port: '8000'
                            },
                            CSV_GAERTLER: {
                                path: '/loadCSV/gaertler',
                                port: '8000'
                            },
                            CSV_VERSICHERTE: {
                                path: '/loadCSV/versicherte',
                                port: '8000'
                            },
                            JSON_VERSICHERTE: {
                                path: '/api/versicherte',
                                port: '8000'
                            }
                        }
                    }
                }
            }


            ready() {
                super.ready();
                this._setActualLocation();
            }

            _setActualLocation() {
                this.set('actualLocation', { protocol: window.location.protocol, hostname: window.location.hostname });
            }

            _getSourceURL(uriData, resPath, port) {
                let urlToSource = uriData.protocol + "//" + uriData.hostname + ":" + port + resPath;
                return urlToSource;
            }

            getCats() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CATS_BASIC.path, this.URLS.CATS_BASIC.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCats aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return { cats: [{ name: "" }, { name: "" }, { name: "" }] }
                    } else return response.json();
                }).catch(() => {
                    console.log('getCats die Anfrage an api/cats war nicht erfolgreich')
                });
            }

            postCats(theCats) {
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                //let parsedObject = theCats.json();

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: theCats
                };

                let myRequest = new Request("http://192.168.2.146:8000/api/cats", myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCats antwort" + JSON.stringify(response));
                    this.dispatchEvent(new CustomEvent('catschanged', { bubbles: true, composed: true }));
                    return response.json();
                }).catch(() => {
                    console.log('getCats die Anfrage an api/cats war nicht erfolgreich')
                });

            }

            getCSV() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_BASIC.path, this.URLS.CSV_BASIC.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCSVs aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return [['firstName', 'lastName', 'street', 'city'], [, , ,]]
                    } else return response.json();
                }).catch(() => {
                    console.log('getCSV die Anfrage an /loadCSV/test war nicht erfolgreich')
                });
            }

            getGaertlerCSV() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_GAERTLER.path, this.URLS.CSV_GAERTLER.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCSVs aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return [['firstName', 'lastName', 'street', 'city'], [, , ,]]
                    } else return response.json();
                }).catch((err) => {
                    console.log('getGaertlerCSV die Anfrage an /loadCSV/gaertler war nicht erfolgreich')
                    return Promise.reject(err);
                });
            }

            getVersicherteCSV() {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_VERSICHERTE.path, this.URLS.CSV_VERSICHERTE.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("getCSVs aaaaaaaantwort" + JSON.stringify(response));
                    if (response.status === 204) {
                        return [['firstName', 'lastName', 'street', 'city'], [, , ,]]
                    } else return response.json();
                }).catch((err) => {
                    console.log('getGaertlerCSV die Anfrage an /loadCSV/gaertler war nicht erfolgreich')
                    return Promise.reject(err);
                });
            }

            postVersicherteAsJSON(versicherte) {
                console.log('topost' + JSON.stringify(versicherte))
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_VERSICHERTE.path, this.URLS.JSON_VERSICHERTE.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "application/json");

                let tosend = JSON.stringify(versicherte);

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: tosend
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    console.log("postVersicherteAsJSON antwort" + JSON.stringify(response));
                    if (response && response.ok) {
                        return response.json();
                    } else return undefined;


                }).catch(() => {
                    console.log('postVersicherteAsJSON die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });

            }

            getVersicherteAsJSON() {
                let self = this;
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.JSON_VERSICHERTE.path, this.URLS.JSON_VERSICHERTE.port);
                let myHeaders = new Headers();

                let myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                let myRequest = new Request(sourceURL, myInit);

                return fetch(myRequest).then((response) => {
                    if (response.status && response.status === 204) {
                        console.log("getVersicherte as JSON status 204")
                        return Promise.reject("NotFound");
                    } else {
                        return response.json();
                    }
                })
                    .then((data) => {
                        console.log('basicclient versicherte as jason wird gesetzt auf' + JSON.stringify(data))
                        self.set('versichertejson', data);
                        console.log('basicclient versicherte as json wurde gesetzt auf' + JSON.stringify(this.versicherungconfig))
                        return Promise.resolve(data);
                    })
                    .catch((err) => {
                        console.log('getVersicherungconfig die Anfrage an api/versicherte war nicht erfolgreich' + JSON.stringify(error))
                    });

            }

            exportVersicherteAsCSV(versicherte, destination) {
                let asCSV = this.mapToCSV(versicherte);
                console.log('topost' + JSON.stringify(versicherte))
                if (destination === "server") {
                    return this._exportRemote(asCSV);
                } else if (destination === "lokal") {
                    return this._saveLokalAsCSV(asCSV);
                } else {
                    return this._exportRemote(asCSV);
                }

            }

            _exportRemote(asCSV) {
                let sourceURL = this._getSourceURL(this.actualLocation, this.URLS.CSV_VERSICHERTE.path, this.URLS.CSV_VERSICHERTE.port);
                let myHeaders = new Headers();
                myHeaders.set("Content-Type", "text/plain");

                let myInit = {
                    method: 'POST',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit',
                    body: asCSV
                };

                let myRequest = new Request(sourceURL, myInit);
                return fetch(myRequest).then((response) => {
                    console.log("postVersicherteAscsv antwort" + response);
                    if (response && response.ok) {
                        //debugger;
                        console.log("postVersicherteAscsv antwort1");
                        return response.json();
                    } else { console.log("postVersicherteAscsv antwort2"); return undefined; }


                }).catch(() => {
                    console.log('postVersicherteAscsv die Anfrage an' + sourceURL + ' war nicht erfolgreich')
                });
            }

            _saveLokalAsCSV(asCSV) {
                let nowMoment = moment().format('YYYYMMDD_HHmm')
                var blob = new Blob([asCSV], { type: "text/csv;charset=utf-8" });
                saveAs(blob, "versicherte_" + nowMoment + ".csv");
            }

            mapToCSV(versicherte) {
                let myForCSVArray = [];
                myForCSVArray.push(versicherte.columns);
                versicherte.data.forEach((v) => {
                    let myVerArray = [];
                    for (var key in v) {
                        if (v.hasOwnProperty(key)) {
                            myVerArray.push(String(v[key]));

                        }
                    }
                    myForCSVArray.push(myVerArray);
                })

                let paL = myForCSVArray;
                let toSave = '';
                paL.forEach((rowArr, idx) => {
                    if (idx !== 0) {
                        toSave += '\n';
                    }
                    let strRow = rowArr.join(',');
                    toSave += strRow;

                })
                return toSave;
            }

        }

        window.customElements.define(FirstClient.is, FirstClient);
    </script>
</dom-module>